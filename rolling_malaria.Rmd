---
title: "Proyecto: Rolling Malaria"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_width: 12
    fig_height: 10
---
# Descripción del proyecto

Objetivo principal:

- Explorar el desacople de la relación entre el clima y el número de casos 
reportados de malaria con respecto a las actividades de control realizadas 
en la región de Loreto, Perú.

Objetivos específicos:

- Determinar el modelo estadístico que mejor permita explorar la relación entre 
el clima y el número de casos reportados de malaria en la ventana temporal
del estudio.

- Determinar si el efecto del clima en el número de casos reportados de malaria
varia en el tiempo según el modelo.

# Tabla de datos

## Descripción

Contamos con una tabla de datos con el número de casos reportados de malaria 
(falciparum y vivax) por mes en cada distrito de la región de Loreto desde de 
enero de 2000 a diciembre de 2017. Además, para cada uno de
estos registros se tiene el valor mensual de variables climáticas consideradas
para el estudio.

Las columnas de la tabla acompañadas de su descripción se muestra continuación:

| Columna       | Descripción                                               |
|---------------|-----------------------------------------------------------|
| `district`      | Distrito.                                                 |
| `year`          | Año.                                                      |
| `month`         | Mes.                                                      |
| `falciparum`    | Número de casos de falciparum.                            |
| `vivax`         | Número de casos de vivax.                                 |
| `aet`           | Evapotranspiración real.                                  |
| `prcp`          | Precipitación                                             |
| `q`             | Escorrentía                                               |
| `soil`          | Humedad del suelo.                                        |
| `tmax`          | Temperatura máxima.                                       |
| `tmin`          | Temperatura mínima                                        |
| `water_deficit` | Déficit hídrico.                                          |
| `pop2015`       | Población del distrito en el año 2015.                    |
| `province`      | Provincia a la que pertenece el distrito.                 |
| `region`        | Region/Departamento al que pertenece el distrito (Loreto) |
| `id_district`   | ID del distrito.                                          |

## Vista de la tabla de datos
 
```{r echo=FALSE, message=FALSE, warning=FALSE}
data_path <- file.path('_data/') # Ruta del directorio de datos
file_name <- 'dt_final.csv' # Nombre del archivo
file_path <- file.path(data_path, file_name) # Ruta del archivo

library(tidyverse)

# Nombre de las columnas
col_names <- c(
  'district',
  'year',
  'month',
  'falciparum',
  'vivax',
  'aet',
  'prcp',
  'q',
  'soilm',
  'tmax',
  'tmin',
  'water_deficit',
  'loss',
  'loss_km2',
  'cum_loss_km2',
  'diag',
  'enviro',
  'nets',
  'workers',
  'pamafro',
  'pop2015',
  'province',
  'region',
  'id_district'
)

# Tipos de dato de las columnas
col_types <- readr::cols(
  district = col_character(),
  year = col_integer(),
  month = col_integer(),
  falciparum = col_integer(),
  vivax = col_integer(),
  aet = col_double(),
  prcp = col_double(),
  q = col_double(),
  soilm = col_double(),
  tmax = col_double(),
  tmin = col_double(),
  water_deficit = col_double(),
  loss = col_double(),
  loss_km2 = col_double(),
  cum_loss_km2 = col_double(),
  diag = col_integer(),
  enviro = col_integer(),
  nets = col_integer(),
  workers = col_integer(),
  pamafro = col_integer(),
  pop2015 = col_integer(),
  province = col_character(),
  region = col_character(),
  id_district = col_character()
)

raw_dataset <- 
  readr::read_csv(
    file = file_path,
    col_names = col_names,
    col_types = col_types,
    skip = 1,
    locale = readr::locale(encoding = "utf-8")
  )

raw_dataset %>% 
  dplyr::mutate(
    report_date = 
      lubridate::make_datetime(
        year = year,
        month = month,
        day = 1L
      ),
    malaria = falciparum + vivax
  ) %>% 
  dplyr::mutate(
    control = 
      ifelse(
        test = (report_date >= '2005-09-01' & report_date <= '2010-09-01'),
        yes = 1,
        no = 0
      )
  ) %>% 
  dplyr::arrange(report_date) -> 
  dataset

library(DT)

DT::datatable(
  data = dataset,
  options = 
    list(
      pageLength = 6,
      scrollX = TRUE
    )
)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
#- Data validation

validation <- list()

dataset %>% 
  dplyr::select(report_date) %>% 
  dplyr::distinct() %>% 
  dplyr::count() %>% 
  as.numeric() ->
  validation[['report_date']]

dataset %>% 
  dplyr::select(district) %>% 
  dplyr::distinct() %>% 
  dplyr::count() %>% 
  as.numeric() ->
  validation[['district']]

cat("Número de meses:", 
    validation[['report_date']],
    "\nNúmero de distritos:", 
    validation[['district']])

#-- Number of districts per date recorded
dataset %>% 
  dplyr::group_by(as.character(report_date)) %>% 
  dplyr::count() %>% 
  summary()

#-- Number of dates recorded per district
dataset %>% 
  dplyr::group_by(district) %>% 
  dplyr::count() %>% 
  summary()
```

# Tablas de casos reportados de malaria{.tabset}

## Falciparum {.tabset}

### Región

```{r echo=FALSE, message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::group_by(region) %>% 
  dplyr::summarise(
    n = n(),
    sum = sum(falciparum),
    min = min(falciparum),
    max = max(falciparum),
    no_report = sum(falciparum < 1),
    no_report_percent = round(
      x = 100 * sum(falciparum < 1) / sum(falciparum),
      digits = 2
    )
  ) %>% 
  DT::datatable(
    options = 
      list(
        pageLength = 6,
        scrollX = TRUE
      )
  )
```

### Provincias

```{r echo=FALSE, message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::group_by(province) %>% 
  dplyr::summarise(
    n = n(),
    sum = sum(falciparum),
    min = min(falciparum),
    max = max(falciparum),
    no_report = sum(falciparum < 1),
    no_report_percent = round(
      x = 100 * sum(falciparum < 1) / sum(falciparum),
      digits = 2
    )
  ) %>% 
  DT::datatable(
    options = 
    list(
      pageLength = 6,
      scrollX = TRUE
    )
  )
```

### Distritos

```{r echo=FALSE, message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::group_by(district) %>% 
  dplyr::summarise(
    n = n(),
    sum = sum(falciparum),
    min = min(falciparum),
    max = max(falciparum),
    no_report = sum(falciparum < 1),
    no_report_percent = round(
      x = 100 * sum(falciparum < 1) / sum(falciparum),
      digits = 2
    ),
    pop = mean(pop2015),
    incidence = 1000 * (sum(falciparum) / (mean(pop2015) * 216))
  ) %>% 
  DT::datatable(
    options = 
    list(
      pageLength = 6,
      scrollX = TRUE
    )
  )
```

## Vivax {.tabset}

### Región

```{r echo=FALSE, message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::group_by(district) %>% 
  dplyr::summarise(
    n = n(),
    sum = sum(vivax),
    min = min(vivax),
    max = max(vivax),
    no_report = sum(vivax < 1),
    no_report_percent = round(
      x = 100 * sum(vivax < 1) / sum(vivax),
      digits = 2
    )
  ) %>% 
  DT::datatable(
    options = 
    list(
      pageLength = 6,
      scrollX = TRUE
    )
  )
```

### Provincias

```{r echo=FALSE, message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::group_by(province) %>% 
  dplyr::summarise(
    n = n(),
    sum = sum(vivax),
    min = min(vivax),
    max = max(vivax),
    zero_cases = sum(vivax < 1),
    zero_cases_percent = round(
      x = 100 * sum(vivax < 1) / sum(vivax),
      digits = 2
    )
  ) %>% 
  DT::datatable(
    options = 
    list(
      pageLength = 6,
      scrollX = TRUE
    )
  )
```

### Distritos

```{r echo=FALSE, message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::group_by(district) %>% 
  dplyr::summarise(
    n = n(),
    sum = sum(vivax),
    min = min(vivax),
    max = max(vivax),
    zero_cases = sum(vivax < 1),
    zero_cases_percent = round(
      x = 100 * sum(vivax < 1) / sum(malaria),
      digits = 2
    ),
    pop = mean(pop2015),
    # TODO Calculate incidence for region and province
    incidence = 1000 * (sum(vivax) / (mean(pop2015) * 216))
  ) %>% 
  DT::datatable(
    options = 
    list(
      pageLength = 6,
      scrollX = TRUE
    )
  )
```

# Casos reportados de malaria en el tiempo {.tabset}

## Región

```{r echo=FALSE, message=FALSE, warning=FALSE}
theme_set(theme_light())
library(scales)

control_dates <- 
  dplyr::tibble(
    dates = c(
      lubridate::make_datetime(
        year = 2005,
        month = 10,
        day = 1L
      ),
      lubridate::make_datetime(
        year = 2010,
        month = 09,
        day = 1L
      )
    ),
    type = c(
      'start',
      'end'
    )
  )

dataset %>% 
  dplyr::group_by(
    region,
    report_date
  ) %>% 
  dplyr::summarise(
    falciparum = sum(falciparum),
    vivax = sum(vivax)
  ) %>% 
  tidyr::pivot_longer(
    cols = c(
      falciparum, 
      vivax
    ),
    names_to = 'parasite'
  ) %>% 
  ggplot(
    aes(
      x = report_date, 
      y = value / 1000
    )
  ) +
  geom_line(
    aes(
      colour = parasite
    ),
    size = 0.7
  ) +
  scale_color_manual(
    values = c('#00AFBB', '#E7B800')
  ) +
  geom_vline(
    data = control_dates,
    aes(
      xintercept = as.numeric(dates)
    ),
    linetype = 'dashed',
    colour = 'red',
    alpha = 0.8
  ) +
  scale_x_datetime(
    date_labels = '%Y',
    date_breaks = '1 year'
  ) +
  labs(
    y = 'Número de casos reportados de malaria (x1000)', 
    x = NULL
  ) +
  ggtitle(
    label = 'Número de casos mensuales reportados de malaria (x1000) por parásito
    durante los años 2000 a 2017 en Loreto'
  ) +
  theme(plot.title = element_text(hjust = 0.5))
```

## Provincia

```{r echo=FALSE, message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::group_by(
    province, 
    report_date
  ) %>% 
  dplyr::summarise(
    falciparum = sum(falciparum),
    vivax = sum(vivax)
  ) %>% 
  tidyr::pivot_longer(
    cols = c(
      falciparum, 
      vivax
    ),
    names_to = 'parasite'
  ) %>% 
  ggplot(
    aes(
      x = report_date, 
      y = value 
    )
  ) +
  geom_line(
    aes(
      colour = parasite
    ),
    size = 0.7
  ) +
  scale_color_manual(
    values = c('#00AFBB', '#E7B800')
  ) +
  geom_vline(
    data = control_dates,
    aes(
      xintercept = as.numeric(dates)
    ),
    linetype = 'dashed',
    colour = 'red'
  ) +
  scale_x_datetime(
    date_labels = '%Y',
    date_breaks = '5 year'
  ) +
  labs(
    y = 'Número de casos reportados de malaria', 
    x = NULL
  ) +
  facet_wrap(
    facets = . ~ province,
    scales = 'free'
  ) +
  ggtitle(
    label = 'Número de casos mensuales reportados de malaria por parásito
    durante los años 2000 a 2017 en las provincias de Loreto'
  ) +
  theme(plot.title = element_text(hjust = 0.5))
```

## Distrito

```{r echo=FALSE, message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::group_by(
    district, 
    report_date
  ) %>% 
  dplyr::summarise(
    falciparum = sum(falciparum),
    vivax = sum(vivax)
  ) %>% 
  tidyr::pivot_longer(
    cols = c(
      falciparum, 
      vivax
    ),
    names_to = 'parasite'
  ) %>% 
  ggplot(
    aes(
      x = report_date, 
      y = value 
    )
  ) +
  geom_line(
    aes(
      colour = parasite
    ),
    size = 0.7
  ) +
  scale_color_manual(
    values = c('#00AFBB', '#E7B800')
  ) +
  geom_vline(
    data = control_dates,
    aes(
      xintercept = as.numeric(dates)
    ),
    linetype = 'dashed',
    colour = 'red'
  ) +
  scale_x_datetime(
    date_labels = '%Y',
    date_breaks = '5 year'
  ) +
  labs(
    y = 'Número de casos reportados de malaria', 
    x = NULL
  ) +
  facet_wrap(
    facets = . ~ district,
    scales = 'free'
  ) +
  ggtitle(
    label = 'Número de casos mensuales reportados de malaria por parásito
    durante los años 2000 a 2017 en los distritos de Loreto'
  ) +
  theme(plot.title = element_text(hjust = 0.5))
```

# Rolling correlations {.tabset}

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Static correlations
get_static_correlations <- function(data, cols){
  library(tibble, warn.conflicts = FALSE)
  library(tidyr, warn.conflicts = FALSE)
  
  # Takes the correlation of all the variables in cols w.r.t. the first one
  # in the vector
  cor_matrix <- stats::cor(
    x = data[cols]
  )
  
  cor_vector <- matrix(
    data = cor_matrix[1,],
    nrow = 1,
    dimnames = 
      list(
        NULL,
        names(cor_matrix[1,])
      )
  )
  
  df_correlations <- tibble::as_tibble(
    x = cor_vector
  )
  
  df_correlations_pivot <- 
    tidyr::pivot_longer(
      data = df_correlations,
      cols = cols[2:length(cols)],
      names_to = 'variable',
      values_to = 'value'
    )
  
  return(df_correlations_pivot)
}

# Rolling correlations
get_correlations <- function(data, cols, index){
  library(lubridate, warn.conflicts = FALSE)
  library(tibble, warn.conflicts = FALSE)
  
  # Takes the correlation of all the variables in cols w.r.t. the first one
  # in the vector
  cor_matrix <- stats::cor(
    x = data[cols]
  )
  
  cor_vector <- matrix(
    data = cor_matrix[1,],
    nrow = 1,
    dimnames = 
      list(
        NULL,
        names(cor_matrix[1,])
      )
  )
  
  date <- lubridate::as_datetime(
    x = as.matrix(data[index])
  )
  
  df_correlations <- tibble::tibble(
    from = min(date),
    to = max(date)
  )
  
  df_correlations <- tibble::add_column(
    .data = df_correlations,
    tibble::as_tibble(cor_vector)
  )
  
  return(df_correlations)
}

rolling_correlations <- function(data, cols, index, window) {
  library(slider)
  library(lubridate, warn.conflicts = FALSE)
  
  date <- lubridate::as_datetime(
    x = as.matrix(data[index])
  )
  
  correlations <- slider::slide_period_dfr(
    .x = data,
    .i = date,
    .period = 'month',
    .f = get_correlations,
    cols = cols,
    index = index,
    .every = 1,
    .before = window - 1,
    .complete = TRUE
  )
  
  return(correlations)
}

# Rolling correlations plot

ggplot_rolling_cor <- function(data, cor_data){
  library(ggplot2, warn.conflicts = FALSE)
  
  plot <- ggplot2::ggplot(
    data = data,
    ggplot2::aes(
      x = to,
      y = value
    )
  ) +
  ggplot2::geom_line() +
  ggplot2::scale_x_datetime(
    date_labels = '%Y',
    date_breaks = '1 year'
  ) +
  ggplot2::geom_vline(
    data = control_dates,
    ggplot2::aes(
      xintercept = as.numeric(dates)
    ),
    linetype = 'dashed',
    colour = 'red'
  ) +
  ggplot2::geom_hline(
    data = cor_data,
    ggplot2::aes(
      yintercept = value
    ),
    linetype = 'dashed',
    colour = 'blue'
  ) +
  ggplot2::geom_hline(
    data = control_dates,
    ggplot2::aes(
      yintercept = 0
    ),
    linetype = 'dashed',
    alpha = 0.6
  ) +
  ggplot2::facet_wrap(
    ncol = 1,
    facets = . ~ variable,
    scales = 'free'
  ) +
  ggplot2::labs(
    y = NULL, 
    x = NULL
  )
  
  print(plot)
}
```

## Region {.tabset}

```{r echo=FALSE, message=FALSE, warning=FALSE}
dataset %>%
  dplyr::group_by(
    region, report_date
  ) %>% 
  dplyr::summarise(
    aet = stats::median(aet),
    prcp = stats::median(prcp),
    soilm = stats::median(soilm),
    tmax = stats::median(tmax),
    vivax = sum(vivax),
    falciparum = sum(falciparum)
  ) -> region_dataset

# library(GGally)
# 
# region_dataset %>%
#   GGally::ggpairs(
#     columns = 3:8
#   ) +
#   ggtitle(
#     label = 'Matriz de correlación del número de casos reportados y valores de
#     variables climáticas mensuales durante los años 2005 a 2017
#     en Loreto'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```

### Falciparum {.tabset}

```{r echo=FALSE, message=FALSE, warning=FALSE}
static_cor_falciparum_region <- get_static_correlations(
  data = region_dataset,
  cols = c(
    'falciparum',
    'aet',
    'prcp',
    'soilm',
    'tmax'
  )
) 
```

#### 12 months

```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_cor_12_falciparum_region <- rolling_correlations(
  data = region_dataset,
  cols = c(
    'falciparum',
    'aet',
    'prcp',
    'soilm',
    'tmax'
  ),
  index = 'report_date',
  window = 12
)

# Plot
roll_cor_12_falciparum_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_cor(cor_data = static_cor_falciparum_region)
```

#### 18 months

```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_cor_18_falciparum_region <- rolling_correlations(
  data = region_dataset,
  cols = c(
    'falciparum',
    'aet',
    'prcp',
    'soilm',
    'tmax'
  ),
  index = 'report_date',
  window = 18
)

# Plot
roll_cor_18_falciparum_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_cor(cor_data = static_cor_falciparum_region)
```

#### 24 months

```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_cor_24_falciparum_region <- rolling_correlations(
  data = region_dataset,
  cols = c(
    'falciparum',
    'aet',
    'prcp',
    'soilm',
    'tmax'
  ),
  index = 'report_date',
  window = 24
)

# Plot
roll_cor_24_falciparum_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_cor(cor_data = static_cor_falciparum_region)
```

### Vivax {.tabset}

```{r echo=FALSE, message=FALSE, warning=FALSE}
static_cor_vivax_region <- get_static_correlations(
  data = region_dataset,
  cols = c(
    'vivax',
    'aet',
    'prcp',
    'soilm',
    'tmax'
  )
) 
```

#### 12 months

```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_cor_12_vivax_region <- rolling_correlations(
  data = region_dataset,
  cols = c(
    'vivax',
    'aet',
    'prcp',
    'soilm',
    'tmax'
  ),
  index = 'report_date',
  window = 12
)

# Plot
roll_cor_12_vivax_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_cor(cor_data = static_cor_vivax_region)
```
#### 18 months
```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_cor_18_vivax_region <- rolling_correlations(
  data = region_dataset,
  cols = c(
    'vivax',
    'aet',
    'prcp',
    'soilm',
    'tmax'
  ),
  index = 'report_date',
  window = 18
)

# Plot
roll_cor_18_vivax_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_cor(cor_data = static_cor_vivax_region)
```
#### 24 months
```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_cor_24_vivax_region <- rolling_correlations(
  data = region_dataset,
  cols = c(
    'vivax',
    'aet',
    'prcp',
    'soilm',
    'tmax'
  ),
  index = 'report_date',
  window = 24
)

# Plot
roll_cor_24_vivax_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_cor(cor_data = static_cor_vivax_region)
```

# Rolling regression (Negative Binomial model) {.tabset}

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Rolling regression
get_coefficients <- function(data, formula, index){
  library(MASS)
  library(lubridate, warn.conflicts = FALSE)
  library(tibble, warn.conflicts = FALSE)
  
  model <- MASS::glm.nb(
    formula = formula,
    data = data
  )
  
  coefficients <- model$coefficients
  n_coefficients <- length(coefficients)
  
  coefficients_vector <- matrix(
    data = coefficients,
    nrow = 1,
    ncol = n_coefficients
  )
  
  names_coefficients <- names(coefficients)
  names_coefficients[1] <- 'intercept'
  dimnames(coefficients_vector) <- list(
    NULL,
    names_coefficients
  )
  
  date <- lubridate::as_datetime(
    x = as.matrix(data[index])
  )
  
  df_coefficients <- tibble::tibble(
    from = min(date),
    to = max(date)
  )
  
  df_coefficients <- tibble::add_column(
    .data = df_coefficients,
    tibble::as_tibble(coefficients_vector)
  )
  
  return(df_coefficients)
}

rolling_nb_regression <- function(data, formula, index, window) {
  library(slider)
  library(lubridate, warn.conflicts = FALSE)
  
  date <- lubridate::as_datetime(
    x = as.matrix(data[index])
  )
  
  coefficients <- slider::slide_period_dfr(
    .x = data,
    .i = date,
    .period = 'month',
    .f = get_coefficients,
    formula = formula,
    index = index,
    .every = 1,
    .before = window - 1,
    .complete = TRUE
  )
  
  return(coefficients)
}

# Rolling regression plot

ggplot_rolling_regre <- function(data){
  library(ggplot2, warn.conflicts = FALSE)
  
  plot <- ggplot2::ggplot(
    data = data,
    ggplot2::aes(
      x = to,
      y = value
    )
  ) +
  ggplot2::geom_line() +
  ggplot2::scale_x_datetime(
    date_labels = '%Y',
    date_breaks = '1 year'
  ) +
  ggplot2::geom_vline(
    data = control_dates,
    ggplot2::aes(
      xintercept = as.numeric(dates)
    ),
    linetype = 'dashed',
    colour = 'red'
  ) +
  ggplot2::geom_hline(
    ggplot2::aes(
      yintercept = 0
    ),
    linetype = 'dashed',
    alpha = 0.6
  ) +
  ggplot2::facet_wrap(
    ncol = 1,
    facets = . ~ variable,
    scales = 'free'
  ) +
  ggplot2::labs(
    y = NULL, 
    x = NULL
  )
  
  print(plot)
}
```

## Region {.tabset}

### Falciparum {.tabset}

```{r echo=FALSE, message=FALSE, warning=FALSE}
falciparum_nb_model_formula <- stats::as.formula(
  falciparum ~ aet + prcp + soilm + tmax
)
```

#### 12 months

```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_regre_12_falciparum_region <- rolling_nb_regression(
  data = region_dataset,
  formula = falciparum_nb_model_formula,
  index = 'report_date',
  window = 12
)

# Plot
roll_regre_12_falciparum_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_regre()
```

#### 18 months

```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_regre_18_falciparum_region <- rolling_nb_regression(
  data = region_dataset,
  formula = falciparum_nb_model_formula,
  index = 'report_date',
  window = 18
)

# Plot
roll_regre_18_falciparum_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_regre()
```

#### 24 months

```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_regre_24_falciparum_region <- rolling_nb_regression(
  data = region_dataset,
  formula = falciparum_nb_model_formula,
  index = 'report_date',
  window = 24
)

# Plot
roll_regre_24_falciparum_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_regre()
```

### Vivax {.tabset}

```{r echo=FALSE, message=FALSE, warning=FALSE}
vivax_nb_model_formula <- stats::as.formula(
  vivax ~ aet + prcp + soilm + tmax
)
```

#### 12 months

```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_regre_12_vivax_region <- rolling_nb_regression(
  data = region_dataset,
  formula = vivax_nb_model_formula,
  index = 'report_date',
  window = 12
)

# Plot
roll_regre_12_vivax_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_regre()
```

#### 18 months

```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_regre_18_vivax_region <- rolling_nb_regression(
  data = region_dataset,
  formula = vivax_nb_model_formula,
  index = 'report_date',
  window = 18
)

# Plot
roll_regre_18_vivax_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_regre()
```

#### 24 months

```{r echo=FALSE, message=FALSE, warning=FALSE}
roll_regre_24_vivax_region <- rolling_nb_regression(
  data = region_dataset,
  formula = vivax_nb_model_formula,
  index = 'report_date',
  window = 24
)

# Plot
roll_regre_24_vivax_region %>% 
  tidyr::pivot_longer(
    cols = c(
      aet,
      prcp,
      soilm,
      tmax
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot_rolling_regre()
```

# Time varying coefficients regression (Negative Binomial model) {.tabset}

## Region {.tabset}

```{r echo=FALSE, message=FALSE, warning=FALSE}
region_dataset %>% 
  dplyr::mutate(
    t = as.numeric(report_date)
  ) -> region_dataset

```

### Falciparum

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(mgcv)

falciparum_gam <- mgcv::gam(
  formula = falciparum ~ 
    s(t, by = tmax) + 
    s(t, by = aet) + 
    s(t, by = prcp) + 
    s(t, by = soilm),
  family = nb(),
  data = region_dataset
)

falciparum_smooth_pred <- mgcv::predict.gam(
    object = falciparum_gam,
    type = 'terms',
    se.fit = TRUE
  )

falciparum_smooth_fit <- falciparum_smooth_pred$fit
falciparum_x_matrix <- falciparum_gam$model[c(3, 4, 5, 6)]
falciparum_smooth_values <- falciparum_smooth_fit / falciparum_x_matrix

falciparum_gam_plot_values <- tibble::tibble(
  report_date = region_dataset$report_date,
  tibble::as_tibble(falciparum_smooth_values)
)

falciparum_gam_plot_values %>% 
  tidyr::pivot_longer(
    cols = c(
      tmax,
      aet,
      prcp,
      soilm
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot2::ggplot(
    ggplot2::aes(
      x = report_date,
      y = value
    )
  ) +
  ggplot2::geom_line() +
  ggplot2::scale_x_datetime(
    date_labels = '%Y',
    date_breaks = '1 year'
  ) +
  ggplot2::geom_vline(
    data = control_dates,
    ggplot2::aes(
      xintercept = as.numeric(dates)
    ),
    linetype = 'dashed',
    colour = 'red'
  ) +
  ggplot2::geom_hline(
    ggplot2::aes(
      yintercept = 0
    ),
    linetype = 'dashed',
    alpha = 0.6
  ) +
  ggplot2::facet_wrap(
    ncol = 1,
    facets = . ~ variable,
    scales = 'free'
  ) +
  ggplot2::labs(
    y = NULL, 
    x = NULL
  )
```

### Vivax

```{r echo=FALSE, message=FALSE, warning=FALSE}
vivax_gam <- mgcv::gam(
  formula = vivax ~ 
    s(t, by = tmax) + 
    s(t, by = aet) + 
    s(t, by = prcp) + 
    s(t, by = soilm),
  family = nb(),
  data = region_dataset
)

vivax_smooth_pred <- mgcv::predict.gam(
    object = vivax_gam,
    type = 'terms',
    se.fit = TRUE
  )

vivax_smooth_fit <- vivax_smooth_pred$fit
vivax_x_matrix <- vivax_gam$model[c(3, 4, 5, 6)]
vivax_smooth_values <- vivax_smooth_fit / vivax_x_matrix

vivax_gam_plot_values <- tibble::tibble(
  report_date = region_dataset$report_date,
  tibble::as_tibble(vivax_smooth_values)
)

vivax_gam_plot_values %>% 
  tidyr::pivot_longer(
    cols = c(
      tmax,
      aet,
      prcp,
      soilm
    ),
    names_to = 'variable',
    values_to = 'value'
  ) %>% 
  ggplot2::ggplot(
    ggplot2::aes(
      x = report_date,
      y = value
    )
  ) +
  ggplot2::geom_line() +
  ggplot2::scale_x_datetime(
    date_labels = '%Y',
    date_breaks = '1 year'
  ) +
  ggplot2::geom_vline(
    data = control_dates,
    ggplot2::aes(
      xintercept = as.numeric(dates)
    ),
    linetype = 'dashed',
    colour = 'red'
  ) +
  ggplot2::geom_hline(
    ggplot2::aes(
      yintercept = 0
    ),
    linetype = 'dashed',
    alpha = 0.6
  ) +
  ggplot2::facet_wrap(
    ncol = 1,
    facets = . ~ variable,
    scales = 'free'
  ) +
  ggplot2::labs(
    y = NULL, 
    x = NULL
  )
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(forecast)

# dataset %>% 
#   dplyr::group_by(date) %>% 
#   dplyr::summarise(
#     reported_cases = sum(malaria) 
#   ) %>% 
#   dplyr::select(reported_cases) %>% 
#   ts(
#     start = 2000,
#     frequency = 12
#   ) %>% 
#   forecast::ggseasonplot(
#     polar = TRUE
#     ) +
#   ggtitle(
#     label = 'Polar seasonal plot: \n Número de casos reportados de malaria durante
#     los años 2000 a 2017 en Loreto'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# dataset %>% 
#   dplyr::group_by(date) %>% 
#   dplyr::summarise(
#     reported_cases = sum(malaria) 
#   ) %>% 
#   dplyr::select(reported_cases) %>% 
#   ts(
#     start = 2000,
#     frequency = 12
#   ) %>% 
#   forecast::ggsubseriesplot(
#     polar = TRUE
#   ) +
#   ggtitle(
#     label = 'Seasonal subseries plot: \n Número de casos reportados de malaria durante
#     los años 2000 a 2017 en Loreto'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# dataset %>%
#   dplyr::filter(
#     district == 'ALTO TAPICHE'
#   ) %>%
#   ggplot(
#     aes(
#       x = report_date,
#       y = malaria
#     )
#   ) +
#   geom_line() +
#   scale_x_datetime(
#     date_labels = '%Y',
#     date_breaks = '1 year'
#   ) +
#   labs(
#     y = 'Número de casos reportados de malaria',
#     x = NULL
#   ) +
#   geom_point(
#     data =
#       dplyr::filter(
#         dataset,
#         district == 'ALTO TAPICHE',
#         malaria == 0
#       ),
#     aes(
#       x = report_date,
#       y = malaria
#     ),
#     colour = 'red'
#   ) +
#   ggtitle(
#     label = 'Número de casos mensuales reportados de malaria durante los años
#     2000 a 2017 en el distrito de Alto Tapiche'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# dataset %>%
#   dplyr::filter(
#     district == 'ALTO TAPICHE'
#   ) %>%
#   ggplot(
#     aes(x = malaria)
#   ) +
#   geom_histogram(
#     bins = 50,
#     color = 'black',
#     fill = 'white'
#   ) +
#   ggtitle(
#     label = 'Histograma del número de casos mensuales reportados de malaria
#     durante los años 2000 a 2017 en el distrito de Alto Tapiche'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# library(forecast)
# 
# dataset %>%
#   dplyr::filter(
#     district == 'ALTO TAPICHE',
#     malaria > 0
#   ) %>%
#   dplyr::select(
#     malaria
#   ) %>%
#   ts(
#     start = 2000,
#     frequency = 12
#   ) %>%
#   ggAcf(
#     lag.max = 15
#   ) +
#   ggtitle(
#     label = 'Gráfico de autocorrelación del número de casos mensuales reportados
#     de malaria durante los años 2000 a 2017 en el distrito de Alto Tapiche'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# dataset %>%
#   dplyr::filter(
#     district == 'ALTO TAPICHE',
#     malaria > 0
#   ) %>%
#   dplyr::select(
#     malaria
#   ) %>%
#   stats::ts(
#     start = 2000,
#     frequency = 12
#   ) %>%
#   forecast::ggPacf(
#     lag.max = 15
#   ) +
#   ggtitle(
#     label = 'Gráfico de autocorrelación parcialdel número de casos mensuales
#     reportados de malaria durante los años 2000 a 2017
#     en el distrito de Alto Tapiche'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# dataset %>%
#   dplyr::filter(
#     district == 'ALTO TAPICHE',
#     malaria > 0
#   ) %>%
#   dplyr::select(
#     malaria
#   ) %>%
#   stats::ts(
#     start = 2000,
#     frequency = 12
#   ) %>%
#   forecast::gglagplot(
#     lag.max = 15
#   ) +
#   ggtitle(
#     label = 'Gráfico de dispersión de lags del número de casos mensuales
#     reportados de malaria durantes los años 2000 a 2017
#     en el distrito de Alto Tapiche'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# dataset %>%
#   dplyr::filter(
#     district == 'ALTO TAPICHE',
#     malaria > 0
#   ) %>%
#   dplyr::select(
#     malaria
#   ) %>%
#   stats::ts() %>%
#   stats::Box.test(
#     type = 'Ljung-Box'
#   )
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# dataset %>%
#   dplyr::filter(
#     district == 'ALTO TAPICHE'
#   ) %>%
#   dplyr::select(
#     aet,
#     prcp,
#     soilm,
#     tmax,
#     tmin,
#     malaria
#   ) %>%
#   summary()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# dataset %>%
#   dplyr::filter(district == 'ALTO TAPICHE') %>%
#   dplyr::select(
#     report_date,
#     aet,
#     prcp,
#     soilm,
#     tmax,
#     tmin,
#     malaria
#   ) %>%
#   tidyr::pivot_longer(
#     cols = c(
#       aet,
#       prcp,
#       soilm,
#       tmax,
#       tmin,
#       malaria
#     ),
#     names_to = 'variable'
#   ) %>%
#   ggplot(
#     aes(
#       x = report_date,
#       y = value
#     )
#   ) +
#   geom_line() +
#   scale_x_datetime(
#     date_labels = '%Y',
#     date_breaks = '1 year'
#   ) +
#   facet_grid(
#     facets = variable ~ .,
#     scales = 'free'
#   ) +
#   ggtitle(
#     label = 'Número de casos reportados y valores de variables climáticas mensuales
#     durante los años 2005 a 2017 en el distrito de Alto Tapiche'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5)) +
#   labs(
#     y = NULL,
#     x = NULL
#   )
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# library(GGally)
# 
# dataset %>%
#   dplyr::filter(
#     district == 'ALTO TAPICHE',
#     malaria > 0
#   ) %>%
#   dplyr::select(
#     aet,
#     prcp,
#     soilm,
#     tmax,
#     tmin,
#     malaria
#   ) %>%
#   GGally::ggpairs() +
#   ggtitle(
#     label = 'Matriz de correlación del número de casos reportados y valores de
#     variables climáticas mensuales durante los años 2005 a 2017
#     el distrito de Alto Tapiche'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# dataset %>%
#   dplyr::filter(district == 'ALTO TAPICHE') %>%
#   ggplot(
#     aes(
#       x = aet,
#       y = malaria
#     )
#   ) +
#   geom_point() +
#   geom_smooth(
#     method = 'loess'
#   ) +
#   labs(
#     x = 'Evapotranspiración real',
#     y = 'Número de casos reportados de malaria'
#   ) +
#   ggtitle(
#     label = 'Gráfico de dispersión del número de casos reportados de malaria y
#     los valores de evapotranspiración mensuales durante los años 2000 y 2017
#     en el distrito de Alto Tapiche'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# dataset %>%
#   dplyr::filter(district == 'ALTO TAPICHE') %>%
#   ggplot(
#     aes(
#       x = tmax,
#       y = malaria
#     )
#   ) +
#   geom_point() +
#   geom_smooth(
#     method = 'loess'
#   ) +
#   labs(
#     x = 'Temperatura máxima',
#     y = 'Número de casos reportados de malaria'
#   ) +
#   ggtitle(
#     label = 'Gráfico de dispersión del número de casos reportados de malaria y
#     los valores de temperatura máxima mensuales durante los años 2000 y 2017
#     en el distrito de Alto Tapiche'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# library(TTR)
# library(tidyquant)
# 
# dataset %>%
#   dplyr::filter(
#     district == 'ALTO TAPICHE',
#     malaria > 0
#   ) %>%
#   dplyr::select(
#     report_date,
#     malaria,
#     aet
#   ) %>%
#   tidyquant::tq_mutate_xy(
#     x = aet,
#     y = malaria,
#     mutate_fun = runCor,
#     n = 12,
#     col_rename = 'roll_corr'
#   ) %>%
#   ggplot(
#     aes(
#       x = report_date,
#       y = roll_corr
#     )
#   ) +
#   geom_line() +
#   scale_x_datetime(
#     date_labels = '%Y',
#     date_breaks = '1 year'
#   ) +
#   geom_hline(
#     aes(
#       yintercept = stats::cor(
#         x = aet,
#         y = malaria
#       )
#     ),
#     colour = 'red'
#   ) +
#   ggtitle(
#     label = 'Correlación rolling del número de casos reportados de malaria y
#     los valores de evapotranspiración mensuales durante los años 2000 y 2017
#     en el distrito de Alto Tapiche
#     (ventana = 12 meses)'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5)) +
#   labs(
#     y = 'Correlación',
#     x = NULL
#   )
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# dataset %>%
#   dplyr::filter(
#     district == 'ALTO TAPICHE',
#     malaria > 0
#   ) %>%
#   dplyr::select(
#     report_date,
#     malaria,
#     tmax
#   ) %>%
#   tidyquant::tq_mutate_xy(
#     x = tmax,
#     y = malaria,
#     mutate_fun = runCor,
#     n = 12,
#     col_rename = 'roll_corr'
#   ) %>%
#   ggplot(
#     aes(
#       x = report_date,
#       y = roll_corr
#     )
#   ) +
#   geom_line() +
#   scale_x_datetime(
#     date_labels = '%Y',
#     date_breaks = '1 year'
#   ) +
#   geom_hline(
#     aes(
#       yintercept = stats::cor(
#         x = tmax,
#         y = malaria
#       )
#     ),
#     colour = 'red'
#   ) +
#   ggtitle(
#     label = 'Correlación rolling del número de casos reportados de malaria y
#     los valores de la temperatura máxima mensuales durante los años 2000 y 2017
#     en el distrito de Alto Tapiche
#     (ventana = 12 meses)'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5)) +
#   labs(
#     y = 'Correlación',
#     x = NULL
#   )
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# forecast::ggCcf(
#   x = ts(
#     dplyr::filter(
#       dataset,
#       malaria > 0,
#       district == 'ALTO TAPICHE'
#     )$aet
#   ),
#   y = ts(
#     dplyr::filter(
#       dataset,
#       malaria > 0,
#       district == 'ALTO TAPICHE'
#     )$malaria
#   )
# ) +
#   ggtitle(
#     label = 'Gráfico de correlación cruzada del número de casos reportados de malaria y
#     los valores de evapotranspiración mensuales durante los años 2000 y 2017
#     en el distrito de Alto Tapiche'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# forecast::ggCcf(
#   x = ts(
#     dplyr::filter(
#       dataset,
#       malaria > 0,
#       district == 'ALTO TAPICHE'
#     )$tmax
#   ),
#   y = ts(
#     dplyr::filter(
#       dataset,
#       malaria > 0,
#       district == 'ALTO TAPICHE'
#     )$malaria
#   )
# ) +
#   ggtitle(
#     label = 'Gráfico de correlación cruzada del número de casos reportados de malaria y
#     los valores de la temperatura máxima mensuales durante los años 2000 y 2017
#     en el distrito de Alto Tapiche'
#   ) +
#   theme(plot.title = element_text(hjust = 0.5))
```
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(astsa)

# dplyr::filter(
#   dataset,
#   district == 'ALTO TAPICHE',
#   malaria > 0
# )$malaria %>% 
#   ts() -> malaria
#  
# dplyr::filter(
#   dataset,
#   district == 'ALTO TAPICHE',
#   malaria > 0
# )$aet %>% 
#   ts() -> aet
# 
# dplyr::filter(
#   dataset,
#   district == 'ALTO TAPICHE',
#   malaria > 0
# )$tmax %>% 
#   ts() -> tmax
# 
# astsa::lag2.plot(
#   series1 = aet,
#   series2 = malaria,
#   max.lag = 15,
# ) 
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# astsa::lag2.plot(
#   series1 = tmax,
#   series2 = malaria,
#   max.lag = 15
# )
```









