---
title: "Time-varying coefficients model using GAMs"
output: 
  html_document:
    toc: true
editor_options: 
  chunk_output_type: inline
---

We are going to use *generalized additive models* (GAMs) to estimate time-varying coefficients for climate variables in order to quantify their effects on malaria incidence by specie thought the time period of the study.

First, lets load some packages to handle the tasks we are going to do.

```{r message=FALSE, warning=FALSE}
library(htmltools)

# Utilities
library(tictoc)

# Data loading
library(readr)
library(skimr)

# Data manipulation
library(tibble)
library(lubridate)
library(dplyr)
library(splitTools)
library(scales)
library(DT)
library(stringr)

# Time series
library(forecast)

# Plots
library(ggplot2)
ggplot2::theme_set(theme_bw())
ggplot2::theme_update(panel.grid = element_blank())
library(ggsci)
library(GGally)
library(DHARMa)

# GAM
library(mgcv)
library(gratia)
```

# Data wrangling

## Loading

The cleaned up data can be found on the `~/data/processed/` directory on this repository. Define the file path to read the data. 

```{r}
processed_data_path <- file.path("../data/processed/") 
file_name           <- "pro_malaria-monthly-cases-district-loreto"
file                <- paste(file_name, ".csv", sep = "")
file_path           <- file.path(processed_data_path, file) 
```

Create a variable containing the column names for the data.

```{r message=FALSE, warning=FALSE}
col_names <- c(
  "district",
  "year",
  "month",
  "falciparum",
  "vivax",
  "aet",
  "prcp",
  "q",
  "soilm",
  "tmax",
  "tmin",
  "pop2015",
  "province",
  "region",
  "dttm",
  "time"
)
```

Define column types to optimize the parsing. We exclude `soilm` and `region` for the analysis.

```{r}
# Column types
col_types <- 
  readr::cols_only(
    district      = col_character(),
    year          = col_integer(),
    month         = col_integer(),
    falciparum    = col_integer(),
    vivax         = col_integer(),
    aet           = col_double(),
    prcp          = col_double(),
    q             = col_double(),
    tmax          = col_double(),
    tmin          = col_double(),
    pop2015       = col_integer(),
    province      = col_character(),
    dttm          = col_datetime(),
    time          = col_integer()
  )
```

Reading csv. file into a data frame.

```{r message=FALSE, warning=FALSE}
df_malaria_loreto <- 
  readr::read_csv(
    file      = file_path,
    col_names = col_names,
    col_types = col_types,
    skip      = 1,
    locale    = readr::locale(encoding = "UTF-8")
  )
```

## Parsing

We are going to parse `district`, `province`, `year` and `month` as factors.

```{r}
to_factor <- c("year", "month", "district", "province")

for (col in to_factor) {
  df_malaria_loreto[[col]] <- factor(df_malaria_loreto[[col]])
}
```

## Validation 

Check data structure.

```{r message=FALSE, warning=FALSE}
str(df_malaria_loreto)
```

To display a summary of the data, we first define a variable containing a table with summary statistics for each data type in the data frame using the `skim` function in the `skimr` package.

```{r}
skim_malaria <- skimr::skim(df_malaria_loreto)
```


Then, we display the summary tables for each data type using the `yank` function of the same package:

- Factors:

```{r}
skimr::yank(skim_malaria, "factor")
```

- Numeric:

```{r}
skimr::yank(skim_malaria, "numeric")
```

- Datetime:

```{r}
skimr::yank(skim_malaria, "POSIXct")
```

## Feature engineering

Create a copy of the data frame where we are going to transform and create some new columns.

```{r}
dat <- tibble::tibble(df_malaria_loreto)
```

### Scaling

First, we are going to scale all climate variables from 0 to 1. The aim of this step is to avoid numerical problems in the GAM fitting procedures, and also to have a common scale on the coefficients.

```{r}
to_scale <- c("aet", "prcp", "q", "soilm", "tmax", "tmin")

for (col in to_scale) {
  dat[[col]] <- scales::rescale(df_malaria_loreto[[col]], to = c(0, 1))
}
```

### Lagged variables

Lagged variables are going to be used to build *distributed lag models* (DLM). In order to properly create lagged variables for this data set, first we are going to group the data by districts. Next, we arrange the data in each group by date. Finally, la `lag` function of the package `dplyr` is applied to create lagged variables by 1, 3, 6, and 12 months.

```{r}
dat <- dat %>% 
  dplyr::group_by(district) %>%
  dplyr::arrange(dttm) %>% 
  dplyr::mutate(
    aet_lag1    = dplyr::lag(aet,  n = 1L),
    aet_lag3    = dplyr::lag(aet,  n = 3L),
    aet_lag6    = dplyr::lag(aet,  n = 6L),
    aet_lag12   = dplyr::lag(aet,  n = 12L),
    prcp_lag1   = dplyr::lag(prcp, n = 1L),
    prcp_lag3   = dplyr::lag(prcp, n = 3L),
    prcp_lag6   = dplyr::lag(prcp, n = 6L),
    prcp_lag12  = dplyr::lag(prcp, n = 12L),
    q_lag1      = dplyr::lag(q,    n = 1L),
    q_lag3      = dplyr::lag(q,    n = 3L),
    q_lag6      = dplyr::lag(q,    n = 6L),
    q_lag12     = dplyr::lag(q,    n = 12L),
    soilm_lag1  = dplyr::lag(q,    n = 1L),
    soilm_lag3  = dplyr::lag(q,    n = 3L),
    soilm_lag6  = dplyr::lag(q,    n = 6L),
    soilm_lag12 = dplyr::lag(q,    n = 12L),
    tmax_lag1   = dplyr::lag(tmax, n = 1L),
    tmax_lag3   = dplyr::lag(tmax, n = 3L),
    tmax_lag6   = dplyr::lag(tmax, n = 6L),
    tmax_lag12  = dplyr::lag(tmax, n = 12L),
    tmin_lag1   = dplyr::lag(tmin, n = 1L),
    tmin_lag3   = dplyr::lag(tmin, n = 3L),
    tmin_lag6   = dplyr::lag(tmin, n = 6L),
    tmin_lag12  = dplyr::lag(tmin, n = 12L)
  )
```

```{r}
dat
```

Since `NA` values are going to be present for the first 12 months (because of the 12 month lagged variables), we have to do a filter.

```{r}
dat <- na.omit(dat)
```

Finally, we create a column containing the values of the districts' population on the natural logarithmic scale.

```{r}
dat$ln_pop2015 <- log(dat$pop2015)
```

Display the final data frame for checking.

```{r}
dat
```
# Time-varying coefficients model building

```{r}
# set.seed(20210223)
# 
# indices <- splitTools::partition(
#   y    = dat$district, 
#   type = "stratified", 
#   p    = c(train = 0.88, test = 0.12)
# )
# 
# train <- dat[indices$train, ]
# test  <- dat[indices$test, ]
```

```{r}
# get_oos_dev <- function(model, prediction, y, weights = NULL) {
# 
#   if(is.null(weights)) weights <- rep(1, times= length(y))
# 
#   dev_residuals <- model$family$dev.resids(y, prediction, weights)
#   deviance      <- sum(dev_residuals)
#   deviance
# }
```

## TVCM: Model 0

Predictors: `aet`, `prcp`, `q`, `tmax`, `tmin`

### P. vivax

```{r}
tictoc::tic("GAM model fitting")
vivax_tvcm_0 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,   bs = "tp", k = 50) +
    s(time, by = prcp,  bs = "tp", k = 30) +
    s(time, by = q,     bs = "tp", k = 30) +
    s(time, by = tmax,  bs = "tp", k = 100) +
    s(time, by = tmin,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_0$converged, "\n")

mgcv::summary.gam(vivax_tvcm_0)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_0, type = "deviance", pch = 19, cex = 0.3)
```

```{r}
tibble::tibble(
  x = lubridate::as_datetime(dat$time),
  y = vivax_tvcm_0$residuals
) %>% 
  ggplot(aes(x = x, y = y)) +
  geom_point() +
  scale_x_datetime(date_labels = "%Y", date_breaks = "1 year") +
  labs(x = NULL, y = "Deviance residuals")
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_0, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_0)
```

```{r}
mgcv::concurvity(vivax_tvcm_0, full = FALSE)$estimate
```

### P. falciparum

```{r}
tictoc::tic("GAM model fitting")
falciparum_tvcm_0 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,   bs = "tp", k = 50) +
    s(time, by = prcp,  bs = "tp", k = 30) +
    s(time, by = q,     bs = "tp", k = 30) +
    s(time, by = tmax,  bs = "tp", k = 100) +
    s(time, by = tmin,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_0$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_0)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_0, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_0, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_0)
```

```{r}
mgcv::concurvity(falciparum_tvcm_0, full = FALSE)$estimate
```

## TVCM: Model 1

Predictors: `aet`, `q`, `tmax`, `tmin`

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_1 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,   bs = "tp", k = 50) +
    s(time, by = q,     bs = "tp", k = 30) +
    s(time, by = tmax,  bs = "tp", k = 100) +
    s(time, by = tmin,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_1$converged, "\n")

mgcv::summary.gam(vivax_tvcm_1)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_1, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_1, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_1)
```

```{r}
mgcv::concurvity(vivax_tvcm_1, full = FALSE)$estimate
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_1 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,   bs = "tp", k = 50) +
    s(time, by = q,     bs = "tp", k = 30) +
    s(time, by = tmax,  bs = "tp", k = 100) +
    s(time, by = tmin,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_1$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_1)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_1, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_1, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_1)
```

```{r}
mgcv::concurvity(falciparum_tvcm_1, full = FALSE)$estimate
```

## TVCM: Model 2

Predictors: `aet`, `prcp`, `tmax`, `tmin`

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_2 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,   bs = "tp", k = 50) +
    s(time, by = prcp,  bs = "tp", k = 30) +
    s(time, by = tmax,  bs = "tp", k = 100) +
    s(time, by = tmin,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_2$converged, "\n")

mgcv::summary.gam(vivax_tvcm_2)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_2, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_2, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_2)
```

```{r}
mgcv::concurvity(vivax_tvcm_2, full = FALSE)$estimate
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_2 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,   bs = "tp", k = 50) +
    s(time, by = prcp,  bs = "tp", k = 30) +
    s(time, by = tmax,  bs = "tp", k = 100) +
    s(time, by = tmin,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_2$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_2)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_2, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_2, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_2)
```

```{r}
mgcv::concurvity(falciparum_tvcm_2, full = FALSE)$estimate
```

## TVCM: Model 3

### P. vivax

Predictors: `aet`, `q`, `tmin`

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_3 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,  bs = "tp", k = 50) +
    s(time, by = q,    bs = "tp", k = 30) +
    s(time, by = tmin, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_3$converged, "\n")

mgcv::summary.gam(vivax_tvcm_3)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_3, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_3, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_3)
```

```{r}
mgcv::concurvity(vivax_tvcm_3, full = FALSE)$estimate
```

### P. falciparum

Predictors: `aet`, `q`, `tmin`

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_3 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,  bs = "tp", k = 50) +
    s(time, by = q,    bs = "tp", k = 30) +
    s(time, by = tmin, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_3$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_3)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_3, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_3, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_3)
```

```{r}
mgcv::concurvity(falciparum_tvcm_3, full = FALSE)$estimate
```

## TVCM: Model 4

Predictors: `aet`, `q`, `tmax`

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_4 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,  bs = "tp", k = 50) +
    s(time, by = q,    bs = "tp", k = 30) +
    s(time, by = tmax, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_4$converged, "\n")

mgcv::summary.gam(vivax_tvcm_4)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_4, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_4, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_4)
```

```{r}
mgcv::concurvity(vivax_tvcm_4, full = FALSE)$estimate
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_4 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,  bs = "tp", k = 50) +
    s(time, by = q,    bs = "tp", k = 30) +
    s(time, by = tmax, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_4$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_4)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_4, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_4, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_4)
```

```{r}
mgcv::concurvity(falciparum_tvcm_4, full = FALSE)$estimate
```

## TVCM: Model 5

Predictors: `aet`, `prcp`, `tmin`

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_5_poiss <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,  bs = "tp", k = 50) +
    s(time, by = prcp, bs = "tp", k = 30) +
    s(time, by = tmin, bs = "tp", k = 100),
  family   = poisson(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_5_poiss$converged, "\n")

mgcv::summary.gam(vivax_tvcm_5_poiss)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_5_poiss, pch = 19, cex = 0.3)
```

```{r}
sim_res_vivax_tvcm_5_poiss <- simulateResiduals(
  fittedModel = vivax_tvcm_5_poiss,
  integerResponse = TRUE
)
plot(sim_res_vivax_tvcm_5_poiss)
```

```{r}
testDispersion(sim_res_vivax_tvcm_5_poiss)
```


```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_5 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,  bs = "tp", k = 50) +
    s(time, by = prcp, bs = "tp", k = 30) +
    s(time, by = tmin, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_5$converged, "\n")

mgcv::summary.gam(vivax_tvcm_5)
```

```{r}
sim_res_vivax_tvcm_5 <- simulateResiduals(
  fittedModel = vivax_tvcm_5,
  integerResponse = TRUE,
  n = 1000
)
plot(sim_res_vivax_tvcm_5)
```

```{r}
testDispersion(sim_res_vivax_tvcm_5)
```



```{r}
mgcv::summary.gam(vivax_tvcm_5)$s.table
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_5, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_5, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_5)
```

```{r}
mgcv::concurvity(vivax_tvcm_5, full = FALSE)$estimate
```

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_5 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,  bs = "tp", k = 50) +
    s(time, by = prcp, bs = "tp", k = 30) +
    s(time, by = tmin, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_5$converged, "\n")

mgcv::summary.gam(vivax_tvcm_5)
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_5 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,  bs = "tp", k = 50) +
    s(time, by = prcp, bs = "tp", k = 30) +
    s(time, by = tmin, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_5$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_5)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_5, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_5, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_5)
```

```{r}
mgcv::concurvity(falciparum_tvcm_5, full = FALSE)$estimate
```

## TVCM: Model 6

Predictors: `aet`, `prcp`,`tmax`

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_6 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,  bs = "tp", k = 50) +
    s(time, by = prcp, bs = "tp", k = 30) +
    s(time, by = tmax, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_6$converged, "\n")

mgcv::summary.gam(vivax_tvcm_6)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_6, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_6, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_6)
```

```{r}
mgcv::concurvity(vivax_tvcm_6, full = FALSE)$estimate
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_6 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = aet,  bs = "tp", k = 50) +
    s(time, by = prcp, bs = "tp", k = 30) +
    s(time, by = tmax, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_6$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_6)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_6, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_6, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_6)
```

```{r}
mgcv::concurvity(falciparum_tvcm_6, full = FALSE)$estimate
```

## TVCM: Model 7

Predictors: `q`, `tmin`

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_7 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = q,    bs = "tp", k = 30) +
    s(time, by = tmin, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_7$converged, "\n")

mgcv::summary.gam(vivax_tvcm_7)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_7, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_7, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_7)
```

```{r}
mgcv::concurvity(vivax_tvcm_7, full = FALSE)$estimate
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_7 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = q,    bs = "tp", k = 30) +
    s(time, by = tmin, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_7$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_7)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_7, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_7, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_7)
```

```{r}
mgcv::concurvity(falciparum_tvcm_7, full = FALSE)$estimate
```

## TVCM: Model 8

Predictors: `q`, `tmax`

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_8 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = q,    bs = "tp", k = 30) +
    s(time, by = tmax, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_8$converged, "\n")

mgcv::summary.gam(vivax_tvcm_8)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_8, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_8, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_8)
```

```{r}
mgcv::concurvity(vivax_tvcm_8, full = FALSE)$estimate
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_8 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = q,    bs = "tp", k = 30) +
    s(time, by = tmax, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_8$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_8)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_8, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_8, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_8)
```

```{r}
mgcv::concurvity(falciparum_tvcm_8, full = FALSE)$estimate
```

## TVCM: Model 9

Predictors: `prcp`, `tmin`

### P. vivax 

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_9 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = prcp, bs = "tp", k = 30) +
    s(time, by = tmin, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_9$converged, "\n")

mgcv::summary.gam(vivax_tvcm_9)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_9, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_9, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_9)
```

```{r}
mgcv::concurvity(vivax_tvcm_9, full = FALSE)$estimate
```

### P. falciparum 

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_9 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = prcp, bs = "tp", k = 30) +
    s(time, by = tmin, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_9$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_9)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_9, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_9, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_9)
```

```{r}
mgcv::concurvity(falciparum_tvcm_9, full = FALSE)$estimate
```

## TVCM: Model 10

Predictors: `prcp`, `tmax`

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_10 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = prcp, bs = "tp", k = 30) +
    s(time, by = tmax, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_10$converged, "\n")

mgcv::summary.gam(vivax_tvcm_10)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_10, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_10, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_10)
```

```{r}
mgcv::concurvity(vivax_tvcm_10, full = FALSE)$estimate
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_10 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) +
    s(district, bs = "re", k = 49) +
    s(time, by = prcp, bs = "tp", k = 30) +
    s(time, by = tmax, bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_10$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_10)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_10, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_10, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_10)
```

```{r}
mgcv::concurvity(falciparum_tvcm_10, full = FALSE)$estimate
```

# Model selection

## P. vivax

```{r}
AIC(
  vivax_tvcm_0,
  vivax_tvcm_1,
  vivax_tvcm_2,
  vivax_tvcm_3,
  vivax_tvcm_4,
  vivax_tvcm_5,
  vivax_tvcm_6,
  vivax_tvcm_7,
  vivax_tvcm_8,
  vivax_tvcm_9,
  vivax_tvcm_10
) -> vivax_tvcm_aic
```

```{r}
vivax_tvcms <- list(
  vivax_tvcm_0,
  vivax_tvcm_1,
  vivax_tvcm_2,
  vivax_tvcm_3,
  vivax_tvcm_4,
  vivax_tvcm_5,
  vivax_tvcm_6,
  vivax_tvcm_7,
  vivax_tvcm_8,
  vivax_tvcm_9,
  vivax_tvcm_10
)

n_models <- length(vivax_tvcms)
vivax_tvcm_dev <- rep(0, n_models)

for(i in 1:n_models) {
  vivax_tvcm_dev[i] <- deviance(vivax_tvcms[[i]])
}
```

```{r}
eval_vivax_tvcm <- tibble::tibble(
  model    = row.names(vivax_tvcm_aic),
  df       = round(vivax_tvcm_aic$df, 2),
  aic      = round(vivax_tvcm_aic$AIC, 2),
  deviance = round(vivax_tvcm_dev, 2)
)
```

```{r}
eval_vivax_tvcm$aicDiff <- round(AIC(vivax_tvcm_0) - eval_vivax_tvcm$aic, 2)
```

```{r}
eval_vivax_tvcm
```
```{r}
# readr::write_csv(eval_vivax_tvcm, "eval_vivax_tvcm.csv")
```


## P. falciparum

```{r}
AIC(
  falciparum_tvcm_0,
  falciparum_tvcm_1,
  falciparum_tvcm_2,
  falciparum_tvcm_3,
  falciparum_tvcm_4,
  falciparum_tvcm_5,
  falciparum_tvcm_6,
  falciparum_tvcm_7,
  falciparum_tvcm_8,
  falciparum_tvcm_9,
  falciparum_tvcm_10
) -> falciparum_tvcm_aic
```

```{r}
falciparum_tvcms <- list(
  falciparum_tvcm_0,
  falciparum_tvcm_1,
  falciparum_tvcm_2,
  falciparum_tvcm_3,
  falciparum_tvcm_4,
  falciparum_tvcm_5,
  falciparum_tvcm_6,
  falciparum_tvcm_7,
  falciparum_tvcm_8,
  falciparum_tvcm_9,
  falciparum_tvcm_10
)

n_models <- length(falciparum_tvcms)
falciparum_tvcm_dev <- rep(0, n_models)

for(i in 1:n_models) {
  falciparum_tvcm_dev[i] <- deviance(falciparum_tvcms[[i]])
}
```

```{r}
eval_falciparum_tvcm <- tibble::tibble(
  model    = row.names(falciparum_tvcm_aic),
  df       = round(falciparum_tvcm_aic$df, 2),
  aic      = round(falciparum_tvcm_aic$AIC, 2),
  deviance = round(falciparum_tvcm_dev, 2)
)
```

```{r}
eval_falciparum_tvcm$aicDiff <- round(AIC(falciparum_tvcm_0) - eval_falciparum_tvcm$aic, 2)
```

```{r}
eval_falciparum_tvcm
```

```{r}
# readr::write_csv(eval_falciparum_tvcm, "eval_falciparum_tvcm.csv")
```

# Figure 2

```{r message=FALSE, warning=FALSE}
df_pamafro_period <- tibble::tibble(
  start = lubridate::make_datetime(year = 2005, month = 10, day = 1L), 
  end   = lubridate::make_datetime(year = 2010, month = 09, day = 1L)
)
```

```{r include=FALSE}
plot_vivax_tvcm_5 <- mgcv::plot.gam(
  x          = vivax_tvcm_5,
  n          = 500,
  seWithMean = TRUE, 
  scale      = 0
)

plot_falciparum_tvcm_5 <- mgcv::plot.gam(
  x          = falciparum_tvcm_5,
  n          = 500,
  seWithMean = TRUE, 
  scale      = 0
)
```

```{r}
tvcm_5_terms <- c(
  "Actual Evapotranspiration",
  "Precipitation", 
  "Min Temperature"
)
```

```{r}
get_tvcoef <- function(plot_vivax, plot_falciparum, labels) {
  nplots_vivax      <- length(plot_vivax)
  nplots_falciparum <- length(plot_falciparum)
  
  assertthat::are_equal(nplots_vivax, nplots_falciparum)
  
  nplots <- nplots_vivax
  
  tvcoef_vivax <-  vector(mode = "list", length = nplots - 1)
  
  for (i in 2:nplots) {
    tvcoef_vivax[[(i-1)]] <- 
      tibble::tibble(
        x        = lubridate::as_datetime(plot_vivax[[i]]$x),
        se       = plot_vivax[[i]]$se,
        fit      = plot_vivax[[i]]$fit,
        term     = labels[(i-1)],
        specie = "vivax"
      )
  }
  
  df_tvcoef_vivax <- dplyr::bind_rows(tvcoef_vivax)
  
  tvcoef_falciparum <-  vector(mode = "list", length = nplots - 1)
  
  for (i in 2:nplots) {
    tvcoef_falciparum[[(i-1)]] <- 
      tibble::tibble(
        x        = lubridate::as_datetime(plot_falciparum[[i]]$x),
        se       = plot_falciparum[[i]]$se,
        fit      = plot_falciparum[[i]]$fit,
        term     = labels[(i-1)],
        specie   = "falciparum"
      )
  }
  
  df_tvcoef_falciparum <- dplyr::bind_rows(tvcoef_falciparum)
  
  df_tvcoef <- dplyr::bind_rows(df_tvcoef_vivax, df_tvcoef_falciparum)
  
  df_tvcoef$term   <- factor(df_tvcoef$term, labels)
  df_tvcoef$specie <- factor(
    x      = df_tvcoef$specie, 
    levels = c("vivax", "falciparum"), 
    labels = c("P. vivax", "P. falciparum")
  )
  
  df_tvcoef
}
```

```{r}
plot_tvcm_by_terms <- function(df_tvcm) {
  
  p <- ggplot(df_tvcm)
  
  # Add grid 
  p <- p + facet_wrap(~ term, ncol = 1, scales = "free", strip = "top")
  
  # Add lines
  p <- p + geom_line(mapping = aes(x = x, y = fit, color = specie), size = 1)
  
  # Add confidence intervals
  p <- p + geom_ribbon(
    mapping = aes(
      x    = x,
      y    = fit,
      ymin = fit + se,
      ymax = fit - se,
      fill = specie
    ),
    alpha = 0.1
  )
  
  # Add PAMAFRO's period layer
  p <- p + geom_rect(
    data    = df_pamafro_period,
    mapping = aes(xmin = start, xmax = end), 
    ymin    = -100, 
    ymax    = 100, 
    alpha   = 0.2
  ) 
    
  # Add PAMAFRO's period lines
  p <- p + geom_vline(
    xintercept = c(df_pamafro_period$start, df_pamafro_period$end), 
    linetype   = "dashed", 
    alpha      = 0.6
  )
  
  # Add y = 0 line
  p <- p + geom_hline(mapping = aes(yintercept = 0), alpha = 0.6)
  
  # Scale date
  p <- p + scale_x_datetime(date_labels = "%Y", date_breaks = "1 year")
  
  # Add labels
  p <- p + labs(y = "b(t)", x = NULL)

  # Format layer
  p <- p + theme(legend.position = "top", legend.title = element_blank())
  
  show(p)
}
```

```{r}
df_tvcm_5<- get_tvcoef(
  plot_vivax_tvcm_5, 
  plot_falciparum_tvcm_5, 
  tvcm_5_terms
)
```

```{r fig.height=9, fig.width=8}
plot_tvcm_by_terms(df_tvcm_5)
```

# Table 2

```{r}
get_period <- function(x) {
  ifelse(
    x < df_pamafro_period$start,
    "before",
    ifelse(
      x > df_pamafro_period$end,
      "after",
      "during"
    )
  )
}
```

```{r}
get_ci <- function(x) {
  sprintf("[%s, %s]", round(x[1] - x[2], 2), round(x[1] + x[2], 2))
}
```

```{r}
table_02_sketch = htmltools::withTags(
  table(
    class = "display",
    thead(
      tr(
        th(rowspan = 3, "Climate variable"),
        th(colspan = 4, "Before"),
        th(colspan = 4, "During"),
        th(colspan = 4, "After")
      ),
      tr(
        lapply(rep(c("Min", "Max"), 3), th, colspan = 2)
      ),
      tr(
        lapply(rep(c("Estimate", "95% CI"), 6), th)
      )
    )
  )
)
```

```{r}
df_tvcm_5$period <- apply(df_tvcm_5[, c("x")], 1, get_period)

df_tvcm_5$period <- factor(
  x      = df_tvcm_5$period,
  levels = c("before", "during", "after")
)
```

```{r}
df_tvcm_5 %>% 
  dplyr::group_by(term, period, specie) %>% 
  dplyr::slice_max(fit, n = 1) -> df_tvcm_5_max
```

```{r}
df_tvcm_5 %>% 
  dplyr::group_by(term, period, specie) %>% 
  dplyr::slice_min(fit, n = 1) -> df_tvcm_5_min
```

```{r}
df_tvcm_5_max$extrema <- rep("max", length(df_tvcm_5_max$fit))
df_tvcm_5_min$extrema <- rep("min", length(df_tvcm_5_min$fit))

df_tvcm_5_extrema <- dplyr::bind_rows(df_tvcm_5_max, df_tvcm_5_min)
```

```{r}
df_tvcm_5_extrema$ci <- apply(df_tvcm_5_extrema[, c("fit", "se")], 1, get_ci)
```

## P. vivax

```{r message=FALSE}
df_tvcm_5_extrema %>% 
  dplyr::filter(specie == "P. vivax") %>% 
  dplyr::select(term, period, extrema, fit, ci) %>%
  dplyr::mutate(fit = round(fit, 4)) %>% 
  tidyr::pivot_wider(
    id_cols     = term,
    names_from  = c(period, extrema),
    values_from = c(fit, ci),
    names_sep   = "_"
  ) %>% 
  dplyr::select(
    term, 
    fit_before_min,
    ci_before_min,
    fit_before_max,
    ci_before_max,
    fit_during_min,
    ci_during_min, 
    fit_during_max,
    ci_during_max,
    fit_after_min,
    ci_after_min, 
    fit_after_max,
    ci_after_max
  ) -> df_tvcm_5_extrema_vivax
```

```{r}
df_tvcm_5_extrema_vivax %>% 
  tibble::column_to_rownames(var = "term") %>% 
  DT::datatable(
    container  = table_02_sketch,
    extensions = 'Buttons',
    options    = list(
      dom        = "Bt", 
      scrollX    = TRUE,
      columnDefs = list(list(className = 'dt-center', targets = 6)),
      buttons    = c('copy', 'csv')
    ),
    caption    = "P. vivax"
  )
```

## P. falciparum

```{r message=FALSE}
df_tvcm_5_extrema %>% 
  dplyr::filter(specie == "P. falciparum") %>% 
  dplyr::select(term, period, extrema, fit, ci) %>%
  dplyr::mutate(fit = round(fit, 4)) %>% 
  tidyr::pivot_wider(
    id_cols     = term,
    names_from  = c(period, extrema),
    values_from = c(fit, ci),
    names_sep   = "_"
  ) %>% 
  dplyr::select(
    term, 
    fit_before_min,
    ci_before_min,
    fit_before_max,
    ci_before_max,
    fit_during_min,
    ci_during_min, 
    fit_during_max,
    ci_during_max,
    fit_after_min,
    ci_after_min, 
    fit_after_max,
    ci_after_max
  ) -> df_tvcm_5_extrema_falciparum
```

```{r}
df_tvcm_5_extrema_falciparum %>% 
  tibble::column_to_rownames(var = "term") %>% 
  DT::datatable(
    container  = table_02_sketch,
    extensions = 'Buttons',
    options    = list(
      dom        = "Bt", 
      scrollX    = TRUE,
      columnDefs = list(list(className = 'dt-center', targets = 6)),
      buttons    = c('copy', 'csv')
    ),
    caption    = "P. falciparum"
  )
```

```{r}
df_tvcm_5 %>% 
  dplyr::group_by(period, specie, term) %>% 
  #dplyr::arrange(x) %>% 
  dplyr::filter(
    fit == min(fit) | fit == max(fit)
  )
```

The estimated time-varying coefficients of the climate variables for both models, as well as their approximated 95% confidence interval in each time point on the graph, are shown in Figure 2. As mentioned before, this time-varying coefficients are estimated as smooth functions over time. Although the confidence intervals include the zero most of the time in each case, the global contribution of the estimated smooth functions in the models is significant according to the approximated p-values in the summary table of the fitted model (APPENDIX). Something to highlight is the apparent concurrent drop to a more negative linear contribution of the climate variables at the end of the PAMAFRO intervention. The estimated confidence intervals for the coefficients at the end and some time after the PAMAFRO period are also farther away from zero than anytime in the study. This is more evident in the case of minimum temperature, where a significant drop is visible, for both P. vivax and P. falciparum. In the case of precipitation, this pattern is less evident for P.vivax, and for P. falciparum there seems to be a periodicity in this drop down which casually matches with the end of PAMAFRO intervention. 

Maximum and minimum values of the estimated time-varying coefficients for each model before, during, and after the PAMAFRO intervention, including their 95% confidence intervals, are presented in Table 2. Before the intervention

P. vivax

Use max and min

- Actual evapotranspiration

Before PAMAFRO, the actual evapotranspiration effect's had a change of direction from being negative to being positive, going from -0.93 (95% CI: []) at the begining of this period to 0.24 at the end, which means a 74% decrease in the effect's magnitude. 
During PAMAFRO, an opposite change of direction occurred, going from 0.24 to -0.67, which means a 177% increase in the effect's magnitude.

After PAMAFRO, a change in direction in the effect similar to that of the first period happened, going from -0.68 to 0.63, which means a 7% decrease in the effect's magnitude.

- Precipitation

Before PAMAFRO, the precipitation had a negative effect throughout this period, but its magnitude decreased by 98%, going from -1.81 (CI) to -0.04 (CI).

During PAMAFRO, the precipitation continued to have a negative effect on the incidence, but it increased its magnitude 17 times, going from -0.03 (CI) to -0.53 (CI).

After PAMAFRO, a change in direction in the effect similar to that of the first period happened, going from -0.68 to 0.63, which means a 7% decrease in the effect's magnitude.

- Min temperature

# Distributed lag models with time-varying coefficients

## P. vivax

```{r}
tictoc::tic("GAM model fitting")
vivax_tvc_dlm_5 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) + 
    s(district, bs = "re") +
    s(time, by = aet,         bs = "tp", k = 50) +
    s(time, by = aet_lag1,    bs = "tp", k = 50) +
    s(time, by = aet_lag3,    bs = "tp", k = 50) +
    s(time, by = aet_lag6,    bs = "tp", k = 50) +
    s(time, by = aet_lag12,   bs = "tp", k = 50) +
    s(time, by = prcp,        bs = "tp", k = 30) +
    s(time, by = prcp_lag1,   bs = "tp", k = 30) +
    s(time, by = prcp_lag3,   bs = "tp", k = 30) +
    s(time, by = prcp_lag6,   bs = "tp", k = 30) +
    s(time, by = prcp_lag12,  bs = "tp", k = 30) +
    s(time, by = tmin,        bs = "tp", k = 100) +
    s(time, by = tmin_lag1,   bs = "tp", k = 100) +
    s(time, by = tmin_lag3,   bs = "tp", k = 100) +
    s(time, by = tmin_lag6,   bs = "tp", k = 100) +
    s(time, by = tmin_lag12,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvc_dlm_5$converged, "\n")

mgcv::summary.gam(vivax_tvc_dlm_5)
```

## P. falciparum

```{r}
tictoc::tic("GAM model fitting")
falciparum_tvc_dlm_5 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) + 
    s(district, bs = "re") +
    s(time, by = aet,         bs = "tp", k = 50) +
    s(time, by = aet_lag1,    bs = "tp", k = 50) +
    s(time, by = aet_lag3,    bs = "tp", k = 50) +
    s(time, by = aet_lag6,    bs = "tp", k = 50) +
    s(time, by = aet_lag12,   bs = "tp", k = 50) +
    s(time, by = prcp,        bs = "tp", k = 30) +
    s(time, by = prcp_lag1,   bs = "tp", k = 30) +
    s(time, by = prcp_lag3,   bs = "tp", k = 30) +
    s(time, by = prcp_lag6,   bs = "tp", k = 30) +
    s(time, by = prcp_lag12,  bs = "tp", k = 30) +
    s(time, by = tmin,        bs = "tp", k = 100) +
    s(time, by = tmin_lag1,   bs = "tp", k = 100) +
    s(time, by = tmin_lag3,   bs = "tp", k = 100) +
    s(time, by = tmin_lag6,   bs = "tp", k = 100) +
    s(time, by = tmin_lag12,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()


cat("\nConverged?", falciparum_tvc_dlm_5$converged, "\n")

mgcv::summary.gam(falciparum_tvc_dlm_5)
```

# Figure 3

```{r}
tvc_dlm_5_terms <- c(
  "Actual Evapotranspiration (lag = 0)",
  "Actual Evapotranspiration (lag = 1)",
  "Actual Evapotranspiration (lag = 3)",
  "Actual Evapotranspiration (lag = 6)",
  "Actual Evapotranspiration (lag = 12)",
  "Precipitation (lag = 0)",
  "Precipitation (lag = 1)",
  "Precipitation (lag = 3)",
  "Precipitation (lag = 6)",
  "Precipitation (lag = 12)",
  "Min Temperature (lag = 0)",
  "Min Temperature (lag = 1)",
  "Min Temperature (lag = 3)",
  "Min Temperature (lag = 6)",
  "Min Temperature (lag = 12)"
)
```

```{r include=FALSE}
plot_vivax_tvc_dlm_5 <- mgcv::plot.gam(
  x          = vivax_tvc_dlm_5, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)

plot_falciparum_tvc_dlm_5 <- mgcv::plot.gam(
  x          = falciparum_tvc_dlm_5, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)
```

```{r}
df_tvc_dlm_5 <- get_tvcoef(
  plot_vivax_tvc_dlm_5, 
  plot_falciparum_tvc_dlm_5, 
  tvc_dlm_5_terms
)
```

```{r}
df_tvc_dlm_5
```

```{r}
df_tvc_dlm_5$variable <- factor(
  stringr::str_extract(df_tvc_dlm_5$term, ".*(?=\\s\\()"),
  levels = c("Actual Evapotranspiration", "Precipitation", "Min Temperature")
)

df_tvc_dlm_5$lag <- factor(
  stringr::str_extract(df_tvc_dlm_5$term, "(?<=\\().*(?=\\))"),
  levels = c("lag = 0", "lag = 1", "lag = 3", "lag = 6", "lag = 12")
)
```

```{r fig.height=8, fig.width=12}
df_tvc_dlm_5 %>% 
  ggplot2::ggplot() +
  facet_grid(cols = vars(specie), rows = vars(variable), scales = "free") +
  geom_line(mapping = aes(x = x, y = fit, color = lag), size = 1) +
  geom_ribbon(
    mapping = aes(
      x    = x,
      y    = fit,
      ymin = fit + se,
      ymax = fit - se,
      fill = lag
    ),
    alpha = 0.1
  ) +
  geom_rect(
    data    = df_pamafro_period,
    mapping = aes(xmin = start, xmax = end), 
    ymin    = -60, 
    ymax    = 60, 
    alpha   = 0.2
  ) +
  geom_hline(mapping  = aes(yintercept = 0), alpha = 0.6) +
  geom_vline(
    xintercept = c(df_pamafro_period$start, df_pamafro_period$end),
    linetype   = 'dashed',
    alpha      = 0.8
  ) +
  scale_x_datetime(date_labels = "%Y", date_breaks = "2 year") +
  ggsci::scale_color_npg() +
  ggsci::scale_fill_npg() +
  ylab("b(t)") +
  xlab(NULL) +
  theme(legend.position = "top", legend.title = element_blank())
```

# Lagged variables models

## 1 month

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_5_lag1 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) + 
    s(district, bs = "re") +
    s(time, by = aet_lag1,   bs = "tp", k = 50) +
    s(time, by = prcp_lag1,  bs = "tp", k = 30) +
    s(time, by = tmin_lag1,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_5_lag1$converged, "\n")

mgcv::summary.gam(vivax_tvcm_5_lag1)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_5_lag1, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_5_lag1, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_5_lag1)
```

```{r}
mgcv::concurvity(vivax_tvcm_5_lag1, full = FALSE)$estimate
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_5_lag1 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) + 
    s(district, bs = "re") +
    s(time, by = aet_lag1,   bs = "tp", k = 50) +
    s(time, by = prcp_lag1,  bs = "tp", k = 30) +
    s(time, by = tmin_lag1,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_5_lag1$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_5_lag1)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_5_lag1, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag1, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_5_lag1)
```

```{r}
mgcv::concurvity(falciparum_tvcm_5_lag1, full = FALSE)$estimate
```

Plots

```{r include=FALSE}
plot_vivax_tvcm_5_lag1 <- mgcv::plot.gam(
  x          = vivax_tvcm_5_lag1,
  n          = 500,
  seWithMean = TRUE, 
  scale      = 0
)

plot_falciparum_tvcm_5_lag1 <- mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag1,
  n          = 500,
  seWithMean = TRUE, 
  scale      = 0
)
```

```{r}
tvcm_5_lag1_terms <- c(
  "Actual Evapotranspiration (Lag = 1)",
  "Precipitation (Lag = 1)", 
  "Min Temperature (Lag = 1)"
)
```

```{r}
df_tvcm_5_lag1 <- get_tvcoef(
  plot_vivax_tvcm_5_lag1, 
  plot_falciparum_tvcm_5_lag1, 
  tvcm_5_lag1_terms
)
```

```{r fig.height=9, fig.width=8}
plot_tvcm_by_terms(df_tvcm_5_lag1)
```

## 3 months

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_5_lag3 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) + 
    s(district, bs = "re") +
    s(time, by = aet_lag3,   bs = "tp", k = 50) +
    s(time, by = prcp_lag3,  bs = "tp", k = 30) +
    s(time, by = tmin_lag3,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_5_lag3$converged, "\n")

mgcv::summary.gam(vivax_tvcm_5_lag3)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_5_lag3, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_5_lag3, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_5_lag3)
```

```{r}
mgcv::concurvity(vivax_tvcm_5_lag3, full = FALSE)$estimate
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_5_lag3 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) + 
    s(district, bs = "re") +
    s(time, by = aet_lag3,   bs = "tp", k = 50) +
    s(time, by = prcp_lag3,  bs = "tp", k = 30) +
    s(time, by = tmin_lag3,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_5_lag3$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_5_lag3)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_5_lag3, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag3, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_5_lag3)
```

```{r}
mgcv::concurvity(falciparum_tvcm_5_lag3, full = FALSE)$estimate
```

Plots

```{r include=FALSE}
plot_vivax_tvcm_5_lag3 <- mgcv::plot.gam(
  x          = vivax_tvcm_5_lag3,
  n          = 500,
  seWithMean = TRUE, 
  scale      = 0
)

plot_falciparum_tvcm_5_lag3 <- mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag3,
  n          = 500,
  seWithMean = TRUE, 
  scale      = 0
)
```

```{r}
tvcm_5_lag3_terms <- c(
  "Actual Evapotranspiration (Lag = 3)",
  "Precipitation (Lag = 3)", 
  "Min Temperature (Lag = 3)"
)
```

```{r}
df_tvcm_5_lag3 <- get_tvcoef(
  plot_vivax_tvcm_5_lag3, 
  plot_falciparum_tvcm_5_lag3, 
  tvcm_5_lag3_terms
)
```

```{r fig.height=9, fig.width=8}
plot_tvcm_by_terms(df_tvcm_5_lag3)
```

## 6 months

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_5_lag6 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) + 
    s(district, bs = "re") +
    s(time, by = aet_lag6,   bs = "tp", k = 50) +
    s(time, by = prcp_lag6,  bs = "tp", k = 30) +
    s(time, by = tmin_lag6,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_5_lag6$converged, "\n")

mgcv::summary.gam(vivax_tvcm_5_lag6)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_5_lag6, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_5_lag6, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_5_lag6)
```

```{r}
mgcv::concurvity(vivax_tvcm_5_lag6, full = FALSE)$estimate
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_5_lag6 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) + 
    s(district, bs = "re") +
    s(time, by = aet_lag6,   bs = "tp", k = 50) +
    s(time, by = prcp_lag6,  bs = "tp", k = 30) +
    s(time, by = tmin_lag6,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_5_lag6$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_5_lag6)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_5_lag6, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag6, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_5_lag6)
```

```{r}
mgcv::concurvity(falciparum_tvcm_5_lag6, full = FALSE)$estimate
```

Plots

```{r include=FALSE}
plot_vivax_tvcm_5_lag6 <- mgcv::plot.gam(
  x          = vivax_tvcm_5_lag6,
  n          = 500,
  seWithMean = TRUE, 
  scale      = 0
)

plot_falciparum_tvcm_5_lag6 <- mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag6,
  n          = 500,
  seWithMean = TRUE, 
  scale      = 0
)
```

```{r}
tvcm_5_lag6_terms <- c(
  "Actual Evapotranspiration (Lag = 6)",
  "Precipitation (Lag = 6)", 
  "Min Temperature (Lag = 6)"
)
```

```{r}
df_tvcm_5_lag6 <- get_tvcoef(
  plot_vivax_tvcm_5_lag6, 
  plot_falciparum_tvcm_5_lag6, 
  tvcm_5_lag6_terms
)
```

```{r fig.height=9, fig.width=8}
plot_tvcm_by_terms(df_tvcm_5_lag6)
```

## 12 months

### P. vivax

```{r message=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_5_lag12 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(ln_pop2015) + 
    s(district, bs = "re") +
    s(time, by = aet_lag12,   bs = "tp", k = 50) +
    s(time, by = prcp_lag12,  bs = "tp", k = 30) +
    s(time, by = tmin_lag12,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", vivax_tvcm_5_lag12$converged, "\n")

mgcv::summary.gam(vivax_tvcm_5_lag12)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(vivax_tvcm_5_lag12, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = vivax_tvcm_5_lag12, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(vivax_tvcm_5_lag12)
```

```{r}
mgcv::concurvity(vivax_tvcm_5_lag12, full = FALSE)$estimate
```

### P. falciparum

```{r message=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_5_lag12 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(ln_pop2015) + 
    s(district, bs = "re") +
    s(time, by = aet_lag12,   bs = "tp", k = 50) +
    s(time, by = prcp_lag12,  bs = "tp", k = 30) +
    s(time, by = tmin_lag12,  bs = "tp", k = 100),
  family   = nb(),
  data     = dat,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()

cat("\nConverged?", falciparum_tvcm_5_lag12$converged, "\n")

mgcv::summary.gam(falciparum_tvcm_5_lag12)
```

```{r message=FALSE, warning=FALSE}
par(mfrow = c(2, 2))
mgcv::gam.check(falciparum_tvcm_5_lag12, pch = 19, cex = 0.3)
```

```{r message=FALSE, warning=FALSE}
mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag12, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0, 
  pages      = 1
)
```

```{r}
mgcv::concurvity(falciparum_tvcm_5_lag12)
```

```{r}
mgcv::concurvity(falciparum_tvcm_5_lag12, full = FALSE)$estimate
```

Plots

```{r include=FALSE}
plot_vivax_tvcm_5_lag12 <- mgcv::plot.gam(
  x          = vivax_tvcm_5_lag12,
  n          = 500,
  seWithMean = TRUE, 
  scale      = 0
)

plot_falciparum_tvcm_5_lag12 <- mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag12,
  n          = 500,
  seWithMean = TRUE, 
  scale      = 0
)
```

```{r}
tvcm_5_lag12_terms <- c(
  "Actual Evapotranspiration (Lag = 12)",
  "Precipitation (Lag = 12)", 
  "Min Temperature (Lag = 12)"
)
```

```{r}
df_tvcm_5_lag12 <- get_tvcoef(
  plot_vivax_tvcm_5_lag12, 
  plot_falciparum_tvcm_5_lag12, 
  tvcm_5_lag12_terms
)
```

```{r fig.height=9, fig.width=8}
plot_tvcm_by_terms(df_tvcm_5_lag12)
```

```{r}
df_malaria_loreto %>% 
  group_by(district) %>% 
  summarise(
    vivax_zeros = 100 * (sum(vivax < 1)/n()),
    falciparum_zeros = 100 * (sum(falciparum < 1)/n())
  ) %>% 
  arrange(desc(vivax_zeros))
```

# Compare models

## Lag 0

```{r}
tvcm_lag0_terms <- c(
  "Actual Evapotranspiration (lag = 0)",
  "Precipitation (lag = 0)",
  "Min Temperature (lag = 0)"
)
```

```{r include=FALSE}
plot_vivax_tvcm_lag0 <- mgcv::plot.gam(
  x          = vivax_tvcm_5, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)

plot_falciparum_tvcm_lag0 <- mgcv::plot.gam(
  x          = falciparum_tvcm_5, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)
```

```{r}
df_tvcm_lag0 <- get_tvcoef(
  plot_vivax_tvcm_lag0, 
  plot_falciparum_tvcm_lag0, 
  tvcm_lag0_terms
)
```

## Lag 1

```{r}
tvcm_lag1_terms <- c(
  "Actual Evapotranspiration (lag = 1)",
  "Precipitation (lag = 1)",
  "Min Temperature (lag = 1)"
)
```

```{r include=FALSE}
plot_vivax_tvcm_lag1 <- mgcv::plot.gam(
  x          = vivax_tvcm_5_lag1, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)

plot_falciparum_tvcm_lag1 <- mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag1, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)
```

```{r}
df_tvcm_lag1 <- get_tvcoef(
  plot_vivax_tvcm_lag1, 
  plot_falciparum_tvcm_lag1, 
  tvcm_lag1_terms
)
```

## Lag 3

```{r}
tvcm_lag3_terms <- c(
  "Actual Evapotranspiration (lag = 3)",
  "Precipitation (lag = 3)",
  "Min Temperature (lag = 3)"
)
```

```{r include=FALSE}
plot_vivax_tvcm_lag3 <- mgcv::plot.gam(
  x          = vivax_tvcm_5_lag3, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)

plot_falciparum_tvcm_lag3 <- mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag3, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)
```

```{r}
df_tvcm_lag3 <- get_tvcoef(
  plot_vivax_tvcm_lag3, 
  plot_falciparum_tvcm_lag3, 
  tvcm_lag3_terms
)
```

## Lag 6

```{r}
tvcm_lag6_terms <- c(
  "Actual Evapotranspiration (lag = 6)",
  "Precipitation (lag = 6)",
  "Min Temperature (lag = 6)"
)
```

```{r include=FALSE}
plot_vivax_tvcm_lag6 <- mgcv::plot.gam(
  x          = vivax_tvcm_5_lag6, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)

plot_falciparum_tvcm_lag6 <- mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag6, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)
```

```{r}
df_tvcm_lag6 <- get_tvcoef(
  plot_vivax_tvcm_lag6, 
  plot_falciparum_tvcm_lag6, 
  tvcm_lag6_terms
)
```

## Lag 12

```{r}
tvcm_lag12_terms <- c(
  "Actual Evapotranspiration (lag = 12)",
  "Precipitation (lag = 12)",
  "Min Temperature (lag = 12)"
)
```

```{r include=FALSE}
plot_vivax_tvcm_lag12 <- mgcv::plot.gam(
  x          = vivax_tvcm_5_lag12, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)

plot_falciparum_tvcm_lag12 <- mgcv::plot.gam(
  x          = falciparum_tvcm_5_lag12, 
  n          = 500, 
  seWithMean = TRUE, 
  scale      = 0
)
```

```{r}
df_tvcm_lag12 <- get_tvcoef(
  plot_vivax_tvcm_lag12, 
  plot_falciparum_tvcm_lag12, 
  tvcm_lag12_terms
)
```

## Figure 4

```{r}
df_tvcm_lagged <- rbind(
  df_tvcm_lag0,
  df_tvcm_lag1,
  df_tvcm_lag3,
  df_tvcm_lag6,
  df_tvcm_lag12
)
```

```{r}
df_tvcm_lagged
```

```{r}
df_tvcm_lagged$variable <- factor(
  stringr::str_extract(df_tvcm_lagged$term, ".*(?=\\s\\()"),
  levels = c("Actual Evapotranspiration", "Precipitation", "Min Temperature")
)

df_tvcm_lagged$lag <- factor(
  stringr::str_extract(df_tvcm_lagged$term, "(?<=\\().*(?=\\))"),
  levels = c("lag = 0", "lag = 1", "lag = 3", "lag = 6", "lag = 12")
)
```


```{r fig.height=8, fig.width=12}
df_tvcm_lagged %>% 
  ggplot2::ggplot() +
  facet_grid(cols = vars(specie), rows = vars(variable), scales = "free") +
  geom_line(mapping = aes(x = x, y = fit, color = lag), size = 1) +
  geom_ribbon(
    mapping = aes(
      x    = x,
      y    = fit,
      ymin = fit + se,
      ymax = fit - se,
      fill = lag
    ),
    alpha = 0.1
  ) +
  geom_rect(
    data    = df_pamafro_period,
    mapping = aes(xmin = start, xmax = end), 
    ymin    = -60, 
    ymax    = 60, 
    alpha   = 0.2
  ) +
  geom_hline(mapping  = aes(yintercept = 0), alpha = 0.6) +
  geom_vline(
    xintercept = c(df_pamafro_period$start, df_pamafro_period$end),
    linetype   = 'dashed',
    alpha      = 0.8
  ) +
  scale_x_datetime(date_labels = "%Y", date_breaks = "2 year") +
  ggsci::scale_color_npg() +
  ggsci::scale_fill_npg() +
  ylab("b(t)") +
  xlab(NULL) +
  theme(legend.position = "top", legend.title = element_blank())
```

```{r}
AIC(
  vivax_tvcm_5,
  vivax_tvcm_5_lag1,
  vivax_tvcm_5_lag3,
  vivax_tvcm_5_lag6,
  vivax_tvcm_5_lag12
) -> vivax_tvcm_5_aic
```

Vivax
(AIC: 70783.24, DF: 130.3846)
(AIC: 70689.94, DF: 133.4880)

```{r}
vivax_tvcm_5_aic
```
```{r}
readr::write_csv(vivax_tvcm_5_aic, "eval_vivax_lagged_tvcm.csv")
```


```{r}
AIC(
  falciparum_tvcm_5,
  falciparum_tvcm_5_lag1,
  falciparum_tvcm_5_lag3,
  falciparum_tvcm_5_lag6,
  falciparum_tvcm_5_lag12
) -> falciparum_tvcm_5_aic
```

Falciparum
(AIC: 46213.92, DF: 122.0533)
(AIC: 46137.46, DF: 127.7910)

```{r}
falciparum_tvcm_5_aic
```

```{r}
readr::write_csv(falciparum_tvcm_5_aic, "eval_falciparum_lagged_tvcm.csv")
```

