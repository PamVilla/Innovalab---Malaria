---
title: "Modelling of the count of reported cases of Malaria in Loreto"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_width: 12
    fig_height: 10
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r message=FALSE, warning=FALSE}
library(readr, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(lubridate, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(lme4, warn.conflicts = FALSE)
library(slider, warn.conflicts = FALSE)
library(gamm4, warn.conflicts = FALSE)
library(ggplot2, warn.conflicts = FALSE)
library(tictoc)
library(forecast)
library(gratia)
library(scales)
```

# Data loading 

Create csv. file path. 

```{r echo=TRUE, message=FALSE, warning=FALSE}
data_path <- file.path('../data/') # Data directory path
file_name <- 'dt_final.csv' # csv. file name 
file_path <- file.path(data_path, file_name) # File path
```

Define data types for columns.

```{r message=FALSE, warning=FALSE}
# Column names
col_names <- c(
  "district",
  "year",
  "month",
  "falciparum",
  "vivax",
  "aet",
  "prcp",
  "q",
  "soilm",
  "tmax",
  "tmin",
  "water_deficit",
  "loss",
  "loss_km2",
  "cum_loss_km2",
  "diag",
  "enviro",
  "nets",
  "workers",
  "pamafro",
  "pop2015",
  "province",
  "region",
  "id_district"
)

# Column types
col_types <- 
  readr::cols(
    district      = col_character(),
    year          = col_integer(),
    month         = col_integer(),
    falciparum    = col_integer(),
    vivax         = col_integer(),
    aet           = col_double(),
    prcp          = col_double(),
    q             = col_double(),
    soilm         = col_double(),
    tmax          = col_double(),
    tmin          = col_double(),
    water_deficit = col_double(),
    loss          = col_double(),
    loss_km2      = col_double(),
    cum_loss_km2  = col_double(),
    diag          = col_integer(),
    enviro        = col_integer(),
    nets          = col_integer(),
    workers       = col_integer(),
    pamafro       = col_integer(),
    pop2015       = col_integer(),
    province      = col_character(),
    region        = col_character(),
    id_district   = col_character()
  )
```

Reading csv. file.

```{r message=FALSE, warning=FALSE}
raw_dataset <- 
  readr::read_csv(
    file      = file_path,
    col_names = col_names,
    col_types = col_types,
    skip      = 1,
    locale    = readr::locale(encoding = "utf-8")
  )
```

## Data validation 

Check data structure.

```{r message=FALSE, warning=FALSE}
str(raw_dataset)
```

Check for missing values.

```{r message=FALSE, warning=FALSE}
for (col in names(raw_dataset)) {
  cat(
    "-",
    col, 
    paste(
      sum(is.na(raw_dataset[col])) / dim(raw_dataset)[1], 
      "%", 
      sep = ""
     ),
    "\n"
  )
}
```

Check categorical features.

```{r message=FALSE, warning=FALSE}
cate_features <- c()

for (col in names(raw_dataset)) {
  if (is.character(raw_dataset[[col]])) {
    cate_features <- c(cate_features, col)
  }
}

for (col in cate_features) {
  cat(
    "-",
    col, 
    length(unique(raw_dataset[[col]])), 
    "\n"
  )
}
```

Check numerical features.

```{r message=FALSE, warning=FALSE}
num_features <- setdiff(names(raw_dataset), cate_features)

summary(raw_dataset[num_features])
```

# Data preprocessing 

Create a reporting date features in datetime format using `year` and `month` columns.

```{r message=FALSE, warning=FALSE}
dataset <- 
  raw_dataset %>% 
    dplyr::mutate(
      reporting_date = 
        lubridate::make_datetime(
          year  = year,
          month = month,
          day   = 1L
        ) 
    )

dataset <- 
  dataset %>% 
  dplyr::arrange(reporting_date)
```

Encode `distric` and `province` as factors.

```{r message=FALSE, warning=FALSE}
dataset <- 
  dataset %>% 
    dplyr::mutate(
      reporting_time = as.numeric(
        factor(reporting_date),
        labels = as.character(1:length(dataset$reporting_date))
      ),
      district = factor(district),
      province = factor(province)
    )
```

Create a data frame with the start and end dates of PAMAFRO intervention.

```{r message=FALSE, warning=FALSE}
start <- lubridate::make_datetime(
  year = 2005,
  month = 10,
  day = 1L
)

end <- lubridate::make_datetime(
  year = 2010,
  month = 09,
  day = 1L
)

df_intervention_period <- 
  dplyr::tibble(
    dates = c(start, end),
    type = c(
      'start',
      'end'
    )
  )
```

# Exploratory data analysis

Set `ggplot` theme.

```{r message=FALSE, warning=FALSE}
ggplot2::theme_set(theme_bw())
theme_update(panel.grid = element_blank())
```

Monthly number of malaria cases reported (x1000) in Loreto from 2000 to 2017 by parasite.

```{r message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::group_by(region, reporting_date) %>% 
  dplyr::summarise(
    falciparum = sum(falciparum),
    vivax      = sum(vivax)
  ) %>% 
  tidyr::pivot_longer(
    cols     = c(falciparum, vivax),
    names_to = "parasite"
  ) %>% 
  dplyr::mutate(
    parasite = factor(
      x      = parasite, 
      levels = c("falciparum", "vivax"), 
      labels = c("P. falciparum", "P. vivax")
    )
  ) -> dataset_long

dataset_long %>% 
  ggplot(aes(x = reporting_date, y = value / 1000)) +
  geom_line(aes(colour = parasite), size = 0.7) +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  geom_vline(
    data = df_intervention_period,
    aes(xintercept = as.numeric(dates)),
    linetype = "dashed",
    colour   = "red",
    alpha    = 0.8
  ) +
  scale_x_datetime(date_labels = "%Y", date_breaks = "1 year") +
  labs(y = "Number of malaria cases reported (x1000)", x = NULL) +
  theme(legend.position = "top", legend.title = element_blank())
```

Total number of malaria cases reported (x1000) in Loreto from 2000 to 2017 by parasite.

```{r message=FALSE, warning=FALSE}
dataset %>% 
  summarise(
    vivax = sum(vivax),
    falciparum = sum(falciparum)
  )
```
Year-over-year percentage change of the number of malaria cases reported (x1000) in Loreto from 2000 to 2017 by parasite by parasite.

```{r message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(
    falciparum = sum(falciparum),
    vivax = sum(vivax)
  ) %>% 
  dplyr::arrange(year) %>% 
  dplyr::mutate(
    yoy_falciparum = (falciparum - lag(falciparum)) / lag(falciparum),
    yoy_vivax      = (vivax - lag(vivax)) / lag(vivax)
  ) %>% 
  tidyr::pivot_longer(
    cols     = c(yoy_falciparum, yoy_vivax),
    names_to = "parasite"
  ) %>% 
  dplyr::mutate(
    parasite = factor(
      x      = parasite, 
      levels = c("yoy_falciparum", "yoy_vivax"), 
      labels = c("P. falciparum", "P. vivax")
    )
  ) %>% 
  ggplot(aes(x = year, y = value, fill = parasite)) +
  geom_col(position = "dodge") +
  scale_color_manual(values = c("#00AFBB", "#E7B800")) +
  geom_vline(
    data = tibble(dates = c(2005, 2010)),
    aes(xintercept = dates),
    linetype = "dashed",
    colour   = "red",
    alpha    = 0.8
  ) +
  scale_y_continuous(labels = scales::percent) +
  # scale_x_discrete(breaks = )
  labs(y = "Total number of malaria cases reported (x1000)", x = NULL) +
  theme(legend.position = "top", legend.title = element_blank()) +
  facet_wrap(~ parasite)
```

Top 10 district with higher MIR from 2000 to 2017

```{r message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::mutate(
    ir_falciparum = falciparum / pop2015,
    ir_vivax      = vivax / pop2015
  ) %>% 
  dplyr::group_by(district) %>% 
  dplyr::summarise(
    mir_falciparum = 1000 * mean(ir_falciparum),
    mir_vivax = 1000 * mean(ir_vivax)
  ) %>% 
  dplyr::arrange(desc(mir_vivax)) %>% 
  dplyr::top_n(10)
```
# Model building

## Data wrangling

### Feature scaling

Scale numerical features to have a mean = 0 and standard error = 1.

```{r message=FALSE, warning=FALSE}
cont_features <- 
  c(
    "aet",
    "prcp",
    "q",
    "soilm",
    "tmax",
    "tmin"
  )

std_cont_features <- 
  c(
    "aet_std",
    "prcp_std",
    "q_std",
    "soilm_std",
    "tmax_std",
    "tmin_std"
  )

dataset[, std_cont_features] <- 
  scale(
    x = dataset[, cont_features], 
    scale = TRUE
  )
```

### Lags

Create lag features (1, 3, 6 and 12 months) from meteorological features.

```{r message=FALSE, warning=FALSE}
dataset %>% 
  dplyr::group_by(district) %>% 
  dplyr::arrange(reporting_date) %>% 
  dplyr::mutate(
    aet_l01    = lag(aet_std,   n = 1L),
    aet_l03    = lag(aet_std,   n = 3L),
    aet_l06    = lag(aet_std,   n = 16L),
    aet_l12    = lag(aet_std,   n = 22L),
    prcp_l01   = lag(prcp_std,  n = 1L),
    prcp_l03   = lag(prcp_std,  n = 3L),
    prcp_l06   = lag(prcp_std,  n = 16L),
    prcp_l12   = lag(prcp_std,  n = 22L),
    q_l01      = lag(q_std,     n = 1L),
    q_l03      = lag(q_std,     n = 3L),
    q_l06      = lag(q_std,     n = 16L),
    q_l12      = lag(q_std,     n = 22L),
    soilm_l01  = lag(soilm_std, n = 1L),
    soilm_l03  = lag(soilm_std, n = 3L),
    soilm_l06  = lag(soilm_std, n = 16L),
    soilm_l12  = lag(soilm_std, n = 22L),
    tmax_l01   = lag(tmax_std,  n = 1L),
    tmax_l03   = lag(tmax_std,  n = 3L),
    tmax_l06   = lag(tmax_std,  n = 16L),
    tmax_l12   = lag(tmax_std,  n = 22L),
    tmin_l01   = lag(tmin_std,  n = 1L),
    tmin_l03   = lag(tmin_std,  n = 3L),
    tmin_l06   = lag(tmin_std,  n = 16L),
    tmin_l12   = lag(tmin_std,  n = 22L)
  ) -> dataset
```

## Generalized additive models with random effects

### Vivax

Model with no lag features.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(log(pop2015)) +
    s(district, bs = "re", k = 49) +
    s(reporting_time, by = aet_std,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_std,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_std, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_std,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_std,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm$converged
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm$sp
```

```{r message=FALSE, warning=FALSE}
summary.gam(vivax_tvcm)
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm$aic
```

```{r message=FALSE, warning=FALSE}
appraise(vivax_tvcm)
```

```{r message=FALSE, warning=FALSE}
gam.check(vivax_tvcm)
```

```{r include=FALSE,message=FALSE, warning=FALSE}
plot_vivax_tvcm <- plot.gam(vivax_tvcm)
```

```{r message=FALSE, warning=FALSE}
tibble::tibble(
  vivax_tvcm$model,
  fitted = vivax_tvcm$fitted.values,
  residual = residuals(vivax_tvcm, type = "deviance")
) %>% ggplot(aes(x = fitted, y = residual)) + geom_point()
```

#### Distributed lag models

Model with lag = 1 month.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_l01 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(district, bs = "re") +
    s(reporting_time, by = aet_l01,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l01,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l01, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l01,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l01,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset[!is.na(dataset$soilm_l01), ],
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l01$converged
```

```{r message=FALSE, warning=FALSE}
summary.gam(vivax_tvcm_l01)
```

```{r message=FALSE, warning=FALSE}
gam.check(vivax_tvcm_l01)
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l01$aic
```

```{r include=FALSE, message=FALSE, warning=FALSE}
plot_vivax_tvcm_l01 <- plot.gam(vivax_tvcm_l01)
```

Model with lag = 3 months.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_l03 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(district, bs = "re") +
    s(reporting_time, by = aet_l03,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l03,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l03, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l03,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l03,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset[!is.na(dataset$soilm_l03), ],
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l03$converged
```

```{r message=FALSE, warning=FALSE}
summary.gam(vivax_tvcm_l03)
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l03$aic
```

```{r message=FALSE, warning=FALSE}
gam.check(vivax_tvcm_l03)
```

```{r include=FALSE, message=FALSE, warning=FALSE}
plot_vivax_tvcm_l03 <- plot.gam(vivax_tvcm_l03)
```

Model with lag = 6 months.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_l06 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(district, bs = "re") +
    s(reporting_time, by = aet_l06,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l06,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l06, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l06,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l06,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset[!is.na(dataset$soilm_l06), ],
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l06$converged
```

```{r message=FALSE, warning=FALSE}
summary.gam(vivax_tvcm_l06)
```

```{r message=FALSE, warning=FALSE}
gam.check(vivax_tvcm_l06)
```

```{r include=FALSE, message=FALSE, warning=FALSE}
plot_vivax_tvcm_l06 <- plot.gam(vivax_tvcm_l06)
```

Model with lag = 12 months.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_l12 <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(district, bs = "re") +
    s(reporting_time, by = aet_l12,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l12,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l12, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l12,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l12,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset[!is.na(dataset$soilm_l12), ],
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l12$converged
```

```{r message=FALSE, warning=FALSE}
summary.gam(vivax_tvcm_l12)
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l12$aic
```

```{r message=FALSE, warning=FALSE}
gam.check(vivax_tvcm_l12)
```

```{r include=FALSE, message=FALSE, warning=FALSE}
plot_vivax_tvcm_l12 <- plot.gam(vivax_tvcm_l12)
```

Model with all the lag features.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
vivax_tvcm_l <- mgcv::bam(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(district, bs = "re") +
    s(reporting_time, by = aet_l01,   bs = "tp", k = 20) +
    s(reporting_time, by = aet_l03,   bs = "tp", k = 20) +
    s(reporting_time, by = aet_l06,   bs = "tp", k = 20) +
    s(reporting_time, by = aet_l12,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l01,  bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l03,  bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l06,  bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l12,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l01, bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l03, bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l06, bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l12, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l01,  bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l03,  bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l06,  bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l12,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l01,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l03,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l06,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l12,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset[!is.na(dataset$soilm_l12), ],
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l$converged
```

```{r message=FALSE, warning=FALSE}
summary(vivax_tvcm_l)
```

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l$aic
```

```{r message=FALSE, warning=FALSE}
gam.check(vivax_tvcm_l)
```

```{r include=FALSE, message=FALSE, warning=FALSE}
plot_vivax_tvcm_l <- plot.gam(vivax_tvcm_l)
```

#### Time-varying coefficients plots

```{r message=FALSE, warning=FALSE}
plot_tvcm <- function(plot, labels, ylim) {
  n_plots <- length(plot)
  dfs <-  vector(mode = "list", length = n_plots - 1)
  
  for (i in 2:n_plots) {
    dfs[[(i-1)]] <- 
      tibble::tibble(
        x    = plot[[i]]$x,
        se   = plot[[i]]$se,
        fit  = plot[[i]]$fit,
        term = labels[(i-1)]
      )
  }
  
  df <- dplyr::bind_rows(dfs)
  df$term <- factor(df$term, labels)
  
  tvc_plot <- ggplot(
    data = df,
    aes(x = x, y = fit)
  )

  tvc_plot +
    geom_line(aes(y = fit)) +
    geom_ribbon(
      aes(
        ymin = fit + se,
        ymax = fit - se
      ),
      fill  = "grey70",
      alpha = 0.7
    ) +
    geom_vline(
      data = tibble(dates = c(70, 129)),
      aes(xintercept = dates),
      linetype = "dashed",
      colour   = "red"
    ) +
    geom_hline(
      aes(yintercept = 0),
      linetype = "dashed",
      alpha = 0.6
    ) +
    scale_y_continuous(limits = ylim, n.breaks = 9) +
    scale_x_continuous(limits = c(1, 216), n.breaks = 5) +
    geom_rug(sides = "b") +
    facet_wrap(~ term, ncol = 2) +
    ylab("b(t)") +
    xlab("Reporting time")
}
```

Model with no lag features.

```{r message=FALSE, warning=FALSE}
vivax_ylim <- c(-1.6, 1.6)

vivax_tvcm_labels <- c(
    "Actual Evapotranspiration",
    "Precipitation",
    "Soil Moisture",
    "Max Temperature",
    "Min Temperature"
  )

plot_tvcm(plot_vivax_tvcm, vivax_tvcm_labels, c(-3, 2))
```

Model with lag = 1 month.

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l01_labels <- c(
    "Actual Evapotranspiration (lag = 1)",
    "Precipitation (lag = 1)",
    "Soil Moisture (lag = 1)",
    "Max Temperature (lag = 1)",
    "Min Temperature (lag = 1)"
  )

plot_tvcm(plot_vivax_tvcm_l01, vivax_tvcm_l01_labels, c(-3, 2))
```

Model with lag = 3 months.

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l03_labels <- c(
    "Actual Evapotranspiration (lag = 3)",
    "Precipitation (lag = 3)",
    "Soil Moisture (lag = 3)",
    "Max Temperature (lag = 3)",
    "Min Temperature (lag = 3)"
  )

plot_tvcm(plot_vivax_tvcm_l03, vivax_tvcm_l03_labels, vivax_ylim)
```

Model with lag = 6 months.

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l06_labels <- c(
    "Actual Evapotranspiration (lag = 6)",
    "Precipitation (lag = 6)",
    "Soil Moisture (lag = 6)",
    "Max Temperature (lag = 6)",
    "Min Temperature (lag = 6)"
  )

plot_tvcm(plot_vivax_tvcm_l06, vivax_tvcm_l06_labels, vivax_ylim)
```

Model with lag = 12 months.

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l12_labels <- c(
    "Actual Evapotranspiration (lag = 12)",
    "Precipitation (lag = 12)",
    "Soil Moisture (lag = 12)",
    "Max Temperature (lag = 12)",
    "Min Temperature (lag = 12)"
  )

plot_tvcm(plot_vivax_tvcm_l12, vivax_tvcm_l12_labels, vivax_ylim)
```

Model with all the lag features.

```{r message=FALSE, warning=FALSE}
vivax_tvcm_l_labels <- c(
    "Actual Evapotranspiration (lag = 1)",
    "Actual Evapotranspiration (lag = 3)",
    "Actual Evapotranspiration (lag = 6)",
    "Actual Evapotranspiration (lag = 12)",
    "Precipitation (lag = 1)",
    "Precipitation (lag = 3)",
    "Precipitation (lag = 6)",
    "Precipitation (lag = 12)",
    "Soil Moisture (lag = 1)",
    "Soil Moisture (lag = 3)",
    "Soil Moisture (lag = 6)",
    "Soil Moisture (lag = 12)",
    "Max Temperature (lag = 1)",
    "Max Temperature (lag = 3)",
    "Max Temperature (lag = 6)",
    "Max Temperature (lag = 12)",
    "Min Temperature (lag = 1)",
    "Min Temperature (lag = 3)",
    "Min Temperature (lag = 6)",
    "Min Temperature (lag = 12)"
  )

plot_tvcm(plot_vivax_tvcm_l[1:5], vivax_tvcm_l_labels[1:5], vivax_ylim)
```

```{r message=FALSE, warning=FALSE}
plot_tvcm(plot_vivax_tvcm_l[5:9], vivax_tvcm_l_labels[5:9], vivax_ylim)
```

```{r message=FALSE, warning=FALSE}
plot_tvcm(plot_vivax_tvcm_l[9:13], vivax_tvcm_l_labels[9:13], vivax_ylim)
```

```{r message=FALSE, warning=FALSE}
plot_tvcm(plot_vivax_tvcm_l[13:17], vivax_tvcm_l_labels[13:17], vivax_ylim)
```

```{r message=FALSE, warning=FALSE}
plot_tvcm(plot_vivax_tvcm_l[17:21], vivax_tvcm_l_labels[17:21], vivax_ylim)
```

### Falciparum

Model with no lag features.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(log(pop2015)) +
    s(district, bs = "re", k = 49) +
    s(reporting_time, by = aet_std,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_std,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_std, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_std,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_std,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset,
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm$converged
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm$sp
```

```{r message=FALSE, warning=FALSE}
summary.gam(falciparum_tvcm)
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm$aic
```

```{r message=FALSE, warning=FALSE}
gam.check(falciparum_tvcm)
```

```{r include=FALSE, message=FALSE, warning=FALSE}
plot_falciparum_tvcm <- plot.gam(falciparum_tvcm)
```

Distributed lag models

Model with lag = 1 month.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_l01 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(log(pop2015)) + 
    s(district, bs = "re") +
    s(reporting_time, by = aet_l01,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l01,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l01, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l01,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l01,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset[!is.na(dataset$soilm_l01), ],
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l01$converged
```

```{r message=FALSE, warning=FALSE}
summary.gam(falciparum_tvcm_l01)
```

```{r message=FALSE, warning=FALSE}
gam.check(falciparum_tvcm_l01)
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l01$aic
```

```{r include=FALSE, message=FALSE, warning=FALSE}
plot_falciparum_tvcm_l01 <- plot.gam(falciparum_tvcm_l01)
```

Model with lag = 3 months.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_l03 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(log(pop2015)) + 
    s(district, bs = "re") +
    s(reporting_time, by = aet_l03,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l03,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l03, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l03,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l03,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset[!is.na(dataset$soilm_l03), ],
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l03$converged
```

```{r message=FALSE, warning=FALSE}
summary.gam(falciparum_tvcm_l03)
```

```{r message=FALSE, warning=FALSE}
gam.check(falciparum_tvcm_l03)
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l03$aic
```

```{r include=FALSE, message=FALSE, warning=FALSE}
plot_falciparum_tvcm_l03 <- plot.gam(falciparum_tvcm_l03)
```

Model with lag = 6 months.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_l06 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(log(pop2015)) + 
    s(district, bs = "re") +
    s(reporting_time, by = aet_l06,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l06,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l06, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l06,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l06,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset[!is.na(dataset$soilm_l06), ],
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l06$converged
```

```{r message=FALSE, warning=FALSE}
summary.gam(falciparum_tvcm_l06)
```

```{r message=FALSE, warning=FALSE}
gam.check(falciparum_tvcm_l06)
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l06$aic
```

```{r include=FALSE, message=FALSE, warning=FALSE}
plot_falciparum_tvcm_l06 <- plot.gam(falciparum_tvcm_l06)
```

Model with lag = 12 months.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_l12 <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(log(pop2015)) + 
    s(district, bs = "re") +
    s(reporting_time, by = aet_l12,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l12,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l12, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l12,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l12,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset[!is.na(dataset$soilm_l12), ],
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l12$converged
```

```{r message=FALSE, warning=FALSE}
summary.gam(falciparum_tvcm_l12)
```

```{r message=FALSE, warning=FALSE}
gam.check(falciparum_tvcm_l12)
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l12$aic
```

```{r include=FALSE, message=FALSE, warning=FALSE}
plot_falciparum_tvcm_l12 <- plot.gam(falciparum_tvcm_l12)
```

Model with all lag features.

```{r message=FALSE, warning=FALSE}
tictoc::tic("GAM model fitting")
falciparum_tvcm_l <- mgcv::bam(
  formula = 
    falciparum ~ 
    offset(log(pop2015)) + 
    s(district, bs = "re") +
    s(reporting_time, by = aet_l01,   bs = "tp", k = 20) +
    s(reporting_time, by = aet_l03,   bs = "tp", k = 20) +
    s(reporting_time, by = aet_l06,   bs = "tp", k = 20) +
    s(reporting_time, by = aet_l12,   bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l01,  bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l03,  bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l06,  bs = "tp", k = 20) +
    s(reporting_time, by = prcp_l12,  bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l01, bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l03, bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l06, bs = "tp", k = 20) +
    s(reporting_time, by = soilm_l12, bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l01,  bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l03,  bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l06,  bs = "tp", k = 20) +
    s(reporting_time, by = tmax_l12,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l01,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l03,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l06,  bs = "tp", k = 20) +
    s(reporting_time, by = tmin_l12,  bs = "tp", k = 20),
  family   = nb(),
  data     = dataset[!is.na(dataset$soilm_l12), ],
  method   = "fREML",
  discrete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l$converged
```

```{r message=FALSE, warning=FALSE}
summary.gam(falciparum_tvcm_l)
```

```{r message=FALSE, warning=FALSE}
gam.check(falciparum_tvcm_l)
```

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l$aic
```

```{r include=FALSE, message=FALSE, warning=FALSE}
plot_falciparum_tvcm_l <- plot.gam(falciparum_tvcm_l)
```

#### Time-varying coefficients plots

Model with no lag features.

```{r message=FALSE, warning=FALSE}
falciparum_ylim <- c(-3, 2)

falciparum_tvcm_labels <- c(
    "Actual Evapotranspiration",
    "Precipitation",
    "Soil Moisture",
    "Max Temperature",
    "Min Temperature"
  )

plot_tvcm(plot_falciparum_tvcm, falciparum_tvcm_labels, falciparum_ylim)
```

Model with lag = 1 month.

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l01_labels <- c(
    "Actual Evapotranspiration (lag = 1)",
    "Precipitation (lag = 1)",
    "Soil Moisture (lag = 1)",
    "Max Temperature (lag = 1)",
    "Min Temperature (lag = 1)"
  )

plot_tvcm(plot_falciparum_tvcm_l01, falciparum_tvcm_l01_labels, falciparum_ylim)
```

Model with lag = 3 months.

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l03_labels <- c(
    "Actual Evapotranspiration (lag = 3)",
    "Precipitation (lag = 3)",
    "Soil Moisture (lag = 3)",
    "Max Temperature (lag = 3)",
    "Min Temperature (lag = 3)"
  )

plot_tvcm(plot_falciparum_tvcm_l03, falciparum_tvcm_l03_labels, falciparum_ylim)
```

Model with lag = 6 months.

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l06_labels <- c(
    "Actual Evapotranspiration (lag = 6)",
    "Precipitation (lag = 6)",
    "Soil Moisture (lag = 6)",
    "Max Temperature (lag = 6)",
    "Min Temperature (lag = 6)"
  )

plot_tvcm(plot_falciparum_tvcm_l06, falciparum_tvcm_l06_labels, falciparum_ylim)
```

Model with lag = 12 months.

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l12_labels <- c(
    "Actual Evapotranspiration (lag = 12)",
    "Precipitation (lag = 12)",
    "Soil Moisture (lag = 12)",
    "Max Temperature (lag = 12)",
    "Min Temperature (lag = 12)"
  )

plot_tvcm(plot_falciparum_tvcm_l12, falciparum_tvcm_l12_labels, falciparum_ylim)
```

Model with all lag features.

```{r message=FALSE, warning=FALSE}
falciparum_tvcm_l_labels <- c(
    "Actual Evapotranspiration (lag = 1)",
    "Actual Evapotranspiration (lag = 3)",
    "Actual Evapotranspiration (lag = 6)",
    "Actual Evapotranspiration (lag = 12)",
    "Precipitation (lag = 1)",
    "Precipitation (lag = 3)",
    "Precipitation (lag = 6)",
    "Precipitation (lag = 12)",
    "Soil Moisture (lag = 1)",
    "Soil Moisture (lag = 3)",
    "Soil Moisture (lag = 6)",
    "Soil Moisture (lag = 12)",
    "Max Temperature (lag = 1)",
    "Max Temperature (lag = 3)",
    "Max Temperature (lag = 6)",
    "Max Temperature (lag = 12)",
    "Min Temperature (lag = 1)",
    "Min Temperature (lag = 3)",
    "Min Temperature (lag = 6)",
    "Min Temperature (lag = 12)"
  )

plot_tvcm(plot_falciparum_tvcm_l[1:5], falciparum_tvcm_l_labels[1:5], falciparum_ylim)
```

```{r message=FALSE, warning=FALSE}
plot_tvcm(plot_falciparum_tvcm_l[5:9], falciparum_tvcm_l_labels[5:9], falciparum_ylim)
```

```{r message=FALSE, warning=FALSE}
plot_tvcm(plot_falciparum_tvcm_l[9:13], falciparum_tvcm_l_labels[9:13], c(-5, 5))
```

```{r message=FALSE, warning=FALSE}
plot_tvcm(plot_falciparum_tvcm_l[13:17], falciparum_tvcm_l_labels[13:17], falciparum_ylim)
```

```{r message=FALSE, warning=FALSE}
plot_tvcm(plot_falciparum_tvcm_l[17:21], falciparum_tvcm_l_labels[17:21], falciparum_ylim)
```









