---
title: "Modelling of the count of reported cases of Malaria in Loreto"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_width: 12
    fig_height: 10
    code_folding: hide
editor_options: 
  chunk_output_type: inline
---

```{r message=FALSE, warning=FALSE}
library(readr, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(lubridate, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(lme4, warn.conflicts = FALSE)
library(slider, warn.conflicts = FALSE)
library(gamm4, warn.conflicts = FALSE)
library(ggplot2, warn.conflicts = FALSE)
library(tictoc)
```

# Data loading 

## File path 

```{r message=FALSE, warning=FALSE}
data_path <- file.path('../data/') # Data directory path
file_name <- 'dt_final.csv' # csv. file name 
file_path <- file.path(data_path, file_name) # File path
```

## Column formatting 

```{r message=FALSE, warning=FALSE}
# Column names
col_names <- c(
  "district",
  "year",
  "month",
  "falciparum",
  "vivax",
  "aet",
  "prcp",
  "q",
  "soilm",
  "tmax",
  "tmin",
  "water_deficit",
  "loss",
  "loss_km2",
  "cum_loss_km2",
  "diag",
  "enviro",
  "nets",
  "workers",
  "pamafro",
  "pop2015",
  "province",
  "region",
  "id_district"
)

# Column types
col_types <- 
  readr::cols(
    district      = col_character(),
    year          = col_integer(),
    month         = col_integer(),
    falciparum    = col_integer(),
    vivax         = col_integer(),
    aet           = col_double(),
    prcp          = col_double(),
    q             = col_double(),
    soilm         = col_double(),
    tmax          = col_double(),
    tmin          = col_double(),
    water_deficit = col_double(),
    loss          = col_double(),
    loss_km2      = col_double(),
    cum_loss_km2  = col_double(),
    diag          = col_integer(),
    enviro        = col_integer(),
    nets          = col_integer(),
    workers       = col_integer(),
    pamafro       = col_integer(),
    pop2015       = col_integer(),
    province      = col_character(),
    region        = col_character(),
    id_district   = col_character()
  )
```

## Loading data 

```{r message=FALSE, warning=FALSE}
raw_dataset <- 
  readr::read_csv(
    file      = file_path,
    col_names = col_names,
    col_types = col_types,
    skip      = 1,
    locale    = readr::locale(encoding = "utf-8")
  )
```

## Data validation 

Checking data structure.

```{r message=FALSE, warning=FALSE}
str(raw_dataset)
```

Checking for missing values.

```{r message=FALSE, warning=FALSE}
cat("Percentage of missing values:\n")

for (col in names(raw_dataset)) {
  cat(
    "-",
    col, 
    paste(
      sum(is.na(raw_dataset[col])) / dim(raw_dataset)[1], 
      "%", 
      sep = ""
     ),
    "\n"
  )
}
```

Checking categorical features.

```{r message=FALSE, warning=FALSE}
cate_features <- c()

for (col in names(raw_dataset)) {
  if (is.character(raw_dataset[[col]])) {
    cate_features <- c(cate_features, col)
  }
}

cat("Number of different categories:\n")

for (col in cate_features) {
  cat(
    "-",
    col, 
    length(unique(raw_dataset[[col]])), 
    "\n"
  )
}
```

Checking numerical features.

```{r message=FALSE, warning=FALSE}
num_features <- setdiff(names(raw_dataset), cate_features)

summary(raw_dataset[num_features])
```

# Data preprocessing 

Create a reporting date features in datetime format using `year` and `month` columns.

```{r message=FALSE, warning=FALSE}
dataset <- 
  raw_dataset %>% 
    dplyr::mutate(
      reporting_date = 
        lubridate::make_datetime(
          year  = year,
          month = month,
          day   = 1L
        ) 
    )

dataset <- 
  dataset %>% 
  dplyr::arrange(reporting_date)
```

# Exploratory data analysis

# Model building

## Data wrangling

### Feature encoding

Create a new features for modeling:
- `reporting_time`: encode `reporting_date` values into integers.
- `distric_encoded`: encode `district` categories into integers.
- `province_encoded`: encode `province` categories into integers.

```{r message=FALSE, warning=FALSE}
dataset <- 
  dataset %>% 
    dplyr::mutate(
      reporting_time = 
        as.numeric(
          factor(
            x      = reporting_date, 
            labels = c(as.character(seq(1, 216)))
          )
        ),
      district_encoded = 
        as.numeric(
          factor(
            x      = district, 
            labels = c(as.character(seq(1, 49)))
          )
        ),
      province_encoded = 
        as.numeric(
          factor(
            x      = province, 
            labels = c(as.character(seq(1, 8)))
          )
        )
    )
```

### Feature scaling

```{r message=FALSE, warning=FALSE}
cont_features <- 
  c(
    "aet",
    "prcp",
    "q",
    "soilm",
    "tmax",
    "tmin"
  )

mc_cont_features <- 
  c(
    "aet_mc",
    "prcp_mc",
    "q_mc",
    "soilm_mc",
    "tmax_mc",
    "tmin_mc"
  )

dataset[, mc_cont_features] <- 
  scale(
    x = dataset[, cont_features], 
    scale = FALSE
  )

std_cont_features <- 
  c(
    "aet_std",
    "prcp_std",
    "q_std",
    "soilm_std",
    "tmax_std",
    "tmin_std"
  )

dataset[, std_cont_features] <- 
  scale(
    x = dataset[, cont_features], 
    scale = TRUE
  )
```

## Generalized linear model with random effects

### Vivax

We start with a model with a nested random effect of provinces and district.

```{r}
vivax_glm_nb_base <- 
  lme4::glmer.nb(
    formula = vivax ~ offset(log(pop2015)) + (1 | province/district),
    data    = dataset
  )

summary(vivax_glm_nb_base)
```

We are going to take a step-wise forward predictor selection approach to build the model. At each step, we are going to add the predictors one by one, starting with the base model with the random effects only. The "best" model in each step is going to be the model with the lowest AIC and where all the fixed effects of the predictors are significant. This best model is going to serve as the base model for the following step. When no further additions improve the AIC o neither of them is significant, the selection is finished and we keep the last best model for further analysis.

#### First step: adding single predictors to the base model

- `aet`: actual evapotranspiration

```{r}
vivax_glm_nb_aet <- update(
  vivax_glm_nb_base,
  vivax ~ . + aet
)

summary(vivax_glm_nb_aet)
```

```{r}
vivax_glm_nb_aet <- update(
  vivax_glm_nb_base,
  vivax ~ . + aet_mc
)

summary(vivax_glm_nb_aet)
```

```{r}
vivax_glm_nb_aet <- update(
  vivax_glm_nb_base,
  vivax ~ . + aet_std
)

summary(vivax_glm_nb_aet)
```

- `prcp`: precipitation

```{r}
vivax_glm_nb_prcp <- update(
  vivax_glm_nb_base,
  vivax ~ . + prcp_std
)

summary(vivax_glm_nb_prcp)
```

- `q`: runoff

```{r}
vivax_glm_nb_q <- update(
  vivax_glm_nb_base,
  vivax ~ . + q_std
)

summary(vivax_glm_nb_q)
```

- `soilm`: soil moisture

```{r}
vivax_glm_nb_soilm <- update(
  vivax_glm_nb_base,
  vivax ~ . + soilm_std
)

summary(vivax_glm_nb_soilm)
```

- `tmax`: maximum temperature

```{r}
vivax_glm_nb_tmax <- update(
  vivax_glm_nb_base,
  vivax ~ . + tmax_std
)

summary(vivax_glm_nb_tmax)
```

- `tmin`: minimum temperature

```{r}
vivax_glm_nb_tmin <- update(
  vivax_glm_nb_base,
  vivax ~ . + tmin_std
)

summary(vivax_glm_nb_tmin)
```

Summary

```{r}
AIC(
  vivax_glm_nb_base, 
  vivax_glm_nb_aet,
  vivax_glm_nb_prcp, 
  vivax_glm_nb_q,
  vivax_glm_nb_soilm,
  vivax_glm_nb_tmax,
  vivax_glm_nb_tmin
)
```

#### Second step: adding single predictors to the model with precipitation

- `prcp` and `aet`

```{r}
vivax_glm_nb_21 <- update(
  vivax_glm_nb_prcp,
  vivax ~ . + aet_std
)

summary(vivax_glm_nb_21)
```

```{r}
anova(
  vivax_glm_nb_base,
  vivax_glm_nb_21
)
```

- `prcp` and `q`

```{r}
vivax_glm_nb_23 <- update(
  vivax_glm_nb_prcp,
  vivax ~ . + q_std
)

summary(vivax_glm_nb_23)
```

```{r}
anova(
  vivax_glm_nb_base, vivax_glm_nb_23
)
```

Runoff effect appear to be non-significant. However, recall that precipitation and runoff are highly correlated (r = 0.99), so this is a problem of multicollinearity.

- `prcp` and `soilm`

```{r}
vivax_glm_nb_24 <- update(
  vivax_glm_nb_prcp,
  vivax ~ . + soilm_std
)

summary(vivax_glm_nb_24)
```

```{r}
anova(
  vivax_glm_nb_base, 
  vivax_glm_nb_24
)
```

- `prcp` and `tmax`

```{r}
vivax_glm_nb_25 <- update(
  vivax_glm_nb_prcp,
  vivax ~ . + tmax_std
)

summary(vivax_glm_nb_25)
```

```{r}
anova(
  vivax_glm_nb_base, 
  vivax_glm_nb_25
)
```

- `prcp` and `tmin`

```{r}
vivax_glm_nb_26 <- update(
  vivax_glm_nb_prcp,
  vivax ~ . + tmin_std
)

summary(vivax_glm_nb_26)
```

```{r}
anova(
  vivax_glm_nb_base, 
  vivax_glm_nb_26
)
```

Summary

```{r}
AIC(
  vivax_glm_nb_base, 
  vivax_glm_nb_aet,
  vivax_glm_nb_prcp, 
  vivax_glm_nb_q,
  vivax_glm_nb_soilm,
  vivax_glm_nb_tmax,
  vivax_glm_nb_tmin,
  vivax_glm_nb_21,
  vivax_glm_nb_23,
  vivax_glm_nb_24,
  vivax_glm_nb_25,
  vivax_glm_nb_26
)
```

#### Third step: adding single predictors to the model with precipitation and maximum temperature

- `prcp`, `tmax` and `aet`

```{r}
vivax_glm_nb_251 <- update(
  vivax_glm_nb_25,
  vivax ~ . + aet_std
)

summary(vivax_glm_nb_251)
```

```{r}
anova(
  vivax_glm_nb_base, 
  vivax_glm_nb_251
)
```

- `prcp`, `tmax` and `soilm`

```{r}
vivax_glm_nb_254 <- update(
  vivax_glm_nb_25,
  vivax ~ . + soilm_std
)

summary(vivax_glm_nb_254)
```

```{r}
anova(
  vivax_glm_nb_base, 
  vivax_glm_nb_254
)
```

- `prcp`, `tmax` and `tmin`

```{r}
vivax_glm_nb_256 <- update(
  vivax_glm_nb_25,
  vivax ~ . + tmin_std
)

summary(vivax_glm_nb_256)
```

```{r}
anova(
  vivax_glm_nb_base, 
  vivax_glm_nb_256
)
```

Summary

```{r}
AIC(
  vivax_glm_nb_base, 
  vivax_glm_nb_aet,
  vivax_glm_nb_prcp, 
  vivax_glm_nb_q,
  vivax_glm_nb_soilm,
  vivax_glm_nb_tmax,
  vivax_glm_nb_tmin,
  vivax_glm_nb_21,
  vivax_glm_nb_23,
  vivax_glm_nb_24,
  vivax_glm_nb_25,
  vivax_glm_nb_26,
  vivax_glm_nb_251,
  vivax_glm_nb_254,
  vivax_glm_nb_256
)
```
Adding `aet` to the model with `prcp` and `tmax` (best one so far) slightly improves the fit, but the main effect of `aet` is not significant. 

```{r}
sqrt(diag(vcov(vivax_glm_nb_25)))
```

## Rolling analysis

```{r message=FALSE, warning=FALSE}
ggplot2::theme_set(theme_light())

df_intervention_period <- 
  dplyr::tibble(
    dates = c(
      lubridate::make_datetime(
        year = 2005,
        month = 10,
        day = 1L
      ),
      lubridate::make_datetime(
        year = 2010,
        month = 09,
        day = 1L
      )
    ),
    type = c(
      'start',
      'end'
    )
  )
```


```{r message=FALSE, warning=FALSE}
vivax_rolling_glmer <- function(data) {
  model <- update(
    vivax_glm_nb_base,
    vivax ~ . + prcp_std + tmax_std,
    data    = data
  )
  
  fit <- lme4::fixef(model)[2:3]
  fit_se <- sqrt(diag(vcov(model)))[2:3]
  names(fit_se) <- names(fit)
  
  df <- tibble::tibble(
    reporting_date = max(data$reporting_date),
    predictor      = names(fit),
    fit            = fit,
    fit_se         = fit_se
  )
  return(df)
}
```

### 6 month window

```{r message=FALSE, warning=FALSE}
tictoc::tic("Rolling regression")
vivax_rolling_glm_nb_6 <- slider::slide_period_dfr(
  .x        = dataset,
  .i        = dataset$reporting_date,
  .period   = 'month',
  .f        = vivax_rolling_glmer,
  .every    = 1,
  .before   = 5,
  .complete = TRUE
)
tictoc::toc()
```

```{r message=FALSE, warning=FALSE}
vivax_rolling_glm_nb_6 %>% 
  ggplot2::ggplot(
    aes(x = reporting_date, y = fit)
  ) + 
  ggplot2::geom_line(aes(y = fit)) +
  ggplot2::geom_ribbon(
    aes(
      ymin = fit - 2 * fit_se,
      ymax = fit + 2 * fit_se
    ),
    fill  = "grey70",
    alpha = 0.8
  ) +
  ggplot2::scale_x_datetime(
    date_labels = '%Y',
    date_breaks = '1 year'
  ) +
  ggplot2::geom_vline(
    aes(xintercept = as.numeric(dates)),
    data     = df_intervention_period,
    linetype = "dashed",
    colour   = "red"
  ) +
  ggplot2::geom_hline(
    aes(yintercept = 0),
    linetype = 'dashed',
    alpha    = 0.6
  ) +
  ggplot2::labs(
    y = NULL, 
    x = NULL
  ) +
  ggplot2::facet_wrap(
    ncol   = 1,
    facets = . ~ predictor
  )
```

### 12 month window

```{r message=FALSE, warning=FALSE}
tictoc::tic("Rolling regression")
vivax_rolling_glm_nb_12 <- slider::slide_period_dfr(
  .x        = dataset,
  .i        = dataset$reporting_date,
  .period   = 'month',
  .f        = vivax_rolling_glmer,
  .every    = 1,
  .before   = 11,
  .complete = TRUE
)
tictoc::toc()
```
```{r message=FALSE, warning=FALSE}
vivax_rolling_glm_nb_12 %>% 
  ggplot2::ggplot(
    aes(x = reporting_date, y = fit)
  ) + 
  ggplot2::geom_line(aes(y = fit)) +
  ggplot2::geom_ribbon(
    aes(
      ymin = fit - 2 * fit_se,
      ymax = fit + 2 * fit_se
    ),
    fill  = "grey70",
    alpha = 0.8
  ) +
  ggplot2::scale_x_datetime(
    date_labels = '%Y',
    date_breaks = '1 year'
  ) +
  ggplot2::geom_vline(
    aes(xintercept = as.numeric(dates)),
    data     = df_intervention_period,
    linetype = "dashed",
    colour   = "red"
  ) +
  ggplot2::geom_hline(
    aes(yintercept = 0),
    linetype = 'dashed',
    alpha    = 0.6
  ) +
  ggplot2::labs(
    y = NULL, 
    x = NULL
  ) +
  ggplot2::facet_wrap(
    ncol   = 1,
    facets = . ~ predictor
  )
```

## Generalized additive models with random effects

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_base <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_base$mer)
```

### First step

- `aet`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_aet <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + aet_std,
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_aet$mer)
summary(vivax_gam_nb_aet$gam)
```

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_aet <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + s(reporting_time, by = aet_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_aet$mer)
summary(vivax_gam_nb_s_aet$gam)
```

- `prcp`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_prcp <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + s(reporting_time, by = prcp_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_prcp$mer)
summary(vivax_gam_nb_s_prcp$gam)
```

- `q`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_q <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + s(reporting_time, by = q_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_q$mer)
summary(vivax_gam_nb_s_q$gam)
```

- `soilm`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_soilm <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + s(reporting_time, by = soilm_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_soilm$mer)
summary(vivax_gam_nb_s_soilm$gam)
```

- `tmax`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_tmax <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + s(reporting_time, by = tmax_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_tmax$mer)
summary(vivax_gam_nb_s_tmax$gam)
```

- `tmin`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_tmin <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + s(reporting_time, by = tmin_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_tmin$mer)
summary(vivax_gam_nb_s_tmin$gam)
```

- Summary

```{r}
AIC(
  vivax_gam_nb_s_aet$mer,
  vivax_gam_nb_s_prcp$mer,
  vivax_gam_nb_s_q$mer,
  vivax_gam_nb_s_soilm$mer,
  vivax_gam_nb_s_tmax$mer,
  vivax_gam_nb_s_tmin$mer
)
```
### Second step

- `soilm` and `aet`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_41 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = aet_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_41$mer)
summary(vivax_gam_nb_s_41$gam)
```

- `soilm` and `prcp`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_42 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = prcp_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_42$mer)
summary(vivax_gam_nb_s_42$gam)
```

- `soilm` and `q`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_43 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = q_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_43$mer)
summary(vivax_gam_nb_s_43$gam)
```

- `soilm` and `tmax`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_45 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_45$mer)
summary(vivax_gam_nb_s_45$gam)
```

- `soilm` and `tmin`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_46 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmin_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_46$mer)
summary(vivax_gam_nb_s_46$gam)
```

- Summary

```{r}
AIC(
  vivax_gam_nb_s_41$mer,
  vivax_gam_nb_s_42$mer,
  vivax_gam_nb_s_43$mer,
  vivax_gam_nb_s_45$mer,
  vivax_gam_nb_s_46$mer
)
```
### Third step

- `soilm`, `tmax` and `aet`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_451 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = aet_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_451$mer)
summary(vivax_gam_nb_s_451$gam)
```
- `soilm`, `tmax` and `prcp`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_452 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = prcp_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_452$mer)
summary(vivax_gam_nb_s_452$gam)
```
- `soilm`, `tmax` and `q`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_453 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = q_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_453$mer)
summary(vivax_gam_nb_s_453$gam)
```

- `soilm`, `tmax` and `tmin`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_456 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = tmin_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_456$mer)
summary(vivax_gam_nb_s_456$gam)
```

- Summary

```{r}
aic_third_step <- AIC(
    vivax_gam_nb_s_aet$mer,
    vivax_gam_nb_s_prcp$mer,
    vivax_gam_nb_s_q$mer,
    vivax_gam_nb_s_soilm$mer,
    vivax_gam_nb_s_tmax$mer,
    vivax_gam_nb_s_tmin$mer,
    vivax_gam_nb_s_41$mer,
    vivax_gam_nb_s_42$mer,
    vivax_gam_nb_s_43$mer,
    vivax_gam_nb_s_45$mer,
    vivax_gam_nb_s_46$mer,
    vivax_gam_nb_s_451$mer,
    vivax_gam_nb_s_452$mer,
    vivax_gam_nb_s_453$mer,
    vivax_gam_nb_s_456$mer
  )

tibble::tibble(
  model = row.names(aic_third_step),
  aic_third_step
) %>% 
  dplyr::arrange(AIC)
```

### Fourth step

- `soilm`, `tmax`, `q` and `aet`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_4531 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = q_std) +
    s(reporting_time, by = aet_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_4531$mer)
summary(vivax_gam_nb_s_4531$gam)
```
- `soilm`, `tmax`, `q` and `prcp`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_4532 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = q_std) +
    s(reporting_time, by = prcp_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_4532$mer)
summary(vivax_gam_nb_s_4532$gam)
```
- `soilm`, `tmax`, `q` and `tmin`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_4536 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = q_std) +
    s(reporting_time, by = tmin_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_4536$mer)
summary(vivax_gam_nb_s_4536$gam)
```
- Summary

```{r}
aic_fourth_step <- AIC(
    vivax_gam_nb_s_aet$mer,
    vivax_gam_nb_s_prcp$mer,
    vivax_gam_nb_s_q$mer,
    vivax_gam_nb_s_soilm$mer,
    vivax_gam_nb_s_tmax$mer,
    vivax_gam_nb_s_tmin$mer,
    vivax_gam_nb_s_41$mer,
    vivax_gam_nb_s_42$mer,
    vivax_gam_nb_s_43$mer,
    vivax_gam_nb_s_45$mer,
    vivax_gam_nb_s_46$mer,
    vivax_gam_nb_s_451$mer,
    vivax_gam_nb_s_452$mer,
    vivax_gam_nb_s_453$mer,
    vivax_gam_nb_s_456$mer,
    vivax_gam_nb_s_4531$mer,
    vivax_gam_nb_s_4532$mer,
    vivax_gam_nb_s_4536$mer
  )

tibble::tibble(
  model = row.names(aic_fourth_step),
  aic_fourth_step
) %>% 
  dplyr::arrange(AIC)
```
### Fifth step

- `soilm`, `tmax`, `q`, `prcp` and `aet`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_45321 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = q_std) +
    s(reporting_time, by = prcp_std) +
    s(reporting_time, by = aet_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_45321$mer)
summary(vivax_gam_nb_s_45321$gam)
```
- `soilm`, `tmax`, `q`, `prcp` and `tmin`

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_45326 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = q_std) +
    s(reporting_time, by = prcp_std) +
    s(reporting_time, by = tmin_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_45326$mer)
summary(vivax_gam_nb_s_45326$gam)
```



```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_45216 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = prcp_std) +
    s(reporting_time, by = aet_std) +
    s(reporting_time, by = tmin_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_45216$mer)
summary(vivax_gam_nb_s_45216$gam)
```

- Summary

```{r}
aic_fifth_step <- AIC(
    vivax_gam_nb_s_aet$mer,
    vivax_gam_nb_s_prcp$mer,
    vivax_gam_nb_s_q$mer,
    vivax_gam_nb_s_soilm$mer,
    vivax_gam_nb_s_tmax$mer,
    vivax_gam_nb_s_tmin$mer,
    vivax_gam_nb_s_41$mer,
    vivax_gam_nb_s_42$mer,
    vivax_gam_nb_s_43$mer,
    vivax_gam_nb_s_45$mer,
    vivax_gam_nb_s_46$mer,
    vivax_gam_nb_s_451$mer,
    vivax_gam_nb_s_452$mer,
    vivax_gam_nb_s_453$mer,
    vivax_gam_nb_s_456$mer,
    vivax_gam_nb_s_4531$mer,
    vivax_gam_nb_s_4532$mer,
    vivax_gam_nb_s_4536$mer,
    vivax_gam_nb_s_45321$mer,
    vivax_gam_nb_s_45326$mer
  )

tibble::tibble(
  model = row.names(aic_fifth_step),
  aic_fifth_step
) %>% 
  dplyr::arrange(AIC)
```
### Sixth step

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_full <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = q_std) +
    s(reporting_time, by = prcp_std) +
    s(reporting_time, by = tmin_std) +
    s(reporting_time, by = aet_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_full$mer)
summary(vivax_gam_nb_s_full$gam)
```
```{r}
aic_sixth_step <- AIC(
    vivax_gam_nb_s_aet$mer,
    vivax_gam_nb_s_prcp$mer,
    vivax_gam_nb_s_q$mer,
    vivax_gam_nb_s_soilm$mer,
    vivax_gam_nb_s_tmax$mer,
    vivax_gam_nb_s_tmin$mer,
    vivax_gam_nb_s_41$mer,
    vivax_gam_nb_s_42$mer,
    vivax_gam_nb_s_43$mer,
    vivax_gam_nb_s_45$mer,
    vivax_gam_nb_s_46$mer,
    vivax_gam_nb_s_451$mer,
    vivax_gam_nb_s_452$mer,
    vivax_gam_nb_s_453$mer,
    vivax_gam_nb_s_456$mer,
    vivax_gam_nb_s_4531$mer,
    vivax_gam_nb_s_4532$mer,
    vivax_gam_nb_s_4536$mer,
    vivax_gam_nb_s_45321$mer,
    vivax_gam_nb_s_45326$mer,
    vivax_gam_nb_s_full$mer
  )

tibble::tibble(
  model = row.names(aic_sixth_step),
  aic_sixth_step
) %>% 
  dplyr::arrange(AIC)
```
```{r}
plot(vivax_gam_nb_s_full$gam, pages=1)
```

```{r}
anova(vivax_gam_nb_s_full$gam)
```

### Final step

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_4521 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = prcp_std) +
    s(reporting_time, by = aet_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_4521$mer)
summary(vivax_gam_nb_s_4521$gam)
```


```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_4526 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = prcp_std) +
    s(reporting_time, by = tmin_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_4526$mer)
summary(vivax_gam_nb_s_4526$gam)
```

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_45216 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + 
    s(reporting_time, by = soilm_std) +
    s(reporting_time, by = tmax_std) +
    s(reporting_time, by = prcp_std) +
    s(reporting_time, by = aet_std) +
    s(reporting_time, by = tmin_std),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset,
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_45216$mer)
summary(vivax_gam_nb_s_45216$gam)
```
```{r}
aic_final_step <- AIC(
    vivax_gam_nb_s_aet$mer,
    vivax_gam_nb_s_prcp$mer,
    vivax_gam_nb_s_q$mer,
    vivax_gam_nb_s_soilm$mer,
    vivax_gam_nb_s_tmax$mer,
    vivax_gam_nb_s_tmin$mer,
    vivax_gam_nb_s_41$mer,
    vivax_gam_nb_s_42$mer,
    vivax_gam_nb_s_43$mer,
    vivax_gam_nb_s_45$mer,
    vivax_gam_nb_s_46$mer,
    vivax_gam_nb_s_451$mer,
    vivax_gam_nb_s_452$mer,
    vivax_gam_nb_s_453$mer,
    vivax_gam_nb_s_456$mer,
    vivax_gam_nb_s_4531$mer,
    vivax_gam_nb_s_4532$mer,
    vivax_gam_nb_s_4536$mer,
    vivax_gam_nb_s_45321$mer,
    vivax_gam_nb_s_45326$mer,
    vivax_gam_nb_s_full$mer,
    vivax_gam_nb_s_4521$mer,
    vivax_gam_nb_s_4526$mer,
    vivax_gam_nb_s_45216$mer
  )

tibble::tibble(
  model = row.names(aic_final_step),
  aic_final_step
) %>% 
  dplyr::arrange(AIC)
```

```{r}
plot(vivax_gam_nb_s_45216$gam, pages=1)
```

```{r}
anova(vivax_gam_nb_s_45216$gam)
```

#### Time-varying coefficients plot

```{r}
vivax_gam_pred_terms <- mgcv::predict.gam(
    object = vivax_gam_nb_s_45216$gam,
    type   = 'terms',
    se.fit = TRUE
  )

vivax_gam_predictors <- c(
  "soilm_std", 
  "tmax_std", 
  "prcp_std", 
  "aet_std", 
  "tmin_std"
)

vivax_gam_model_matrix <- vivax_gam_nb_s_45216$gam$model[, vivax_gam_predictors]

vivax_gam_s_coef <- vivax_gam_pred_terms$fit / vivax_gam_model_matrix

vivax_gam_coef_names <- colnames(vivax_gam_model_matrix)

vivax_gam_s_coef_se <- 
  vivax_gam_pred_terms$se.fit / sqrt(vivax_gam_model_matrix ^ 2)

colnames(vivax_gam_s_coef_se) <- vivax_gam_coef_names

df_vivax_gam_coef <- 
  tibble::tibble(
    reporting_date = dataset$reporting_date,
    tibble::as_tibble(vivax_gam_s_coef)
  ) %>% 
  dplyr::group_by(reporting_date) %>% 
  dplyr::summarise(
    soilm_std = mean(soilm_std), 
    tmax_std  = mean(tmax_std),
    prcp_std  = mean(prcp_std),
    aet_std   = mean(aet_std),
    tmin_std  = mean(tmin_std)
  ) %>% 
  tidyr::pivot_longer(
    cols = c(
      soilm_std,
      tmax_std,
      prcp_std,
      aet_std,
      tmin_std
    ),
    names_to  = "predictor",
    values_to = "coef"
  )

df_vivax_gam_coef_se <- 
  tibble::tibble(
    reporting_date = dataset$reporting_date,
    tibble::as_tibble(vivax_gam_s_coef_se)
  ) %>%
  dplyr::group_by(reporting_date) %>% 
  dplyr::summarise(
    soilm_std = mean(soilm_std), 
    tmax_std  = mean(tmax_std),
    prcp_std  = mean(prcp_std),
    aet_std   = mean(aet_std),
    tmin_std  = mean(tmin_std)
  ) %>% 
  tidyr::pivot_longer(
    cols = c(
      soilm_std,
      tmax_std,
      prcp_std,
      aet_std,
      tmin_std
    ),
    names_to  = "predictor",
    values_to = "coef_se"
  )

df_vivax_gam <- 
  df_vivax_gam_coef %>% 
  dplyr::inner_join(
    x  = df_vivax_gam_coef_se,
    by = c('reporting_date', 'predictor')
  )

df_vivax_gam %>% 
  ggplot2::ggplot(
    aes(x = reporting_date, y = coef)
  ) + 
  ggplot2::geom_line(aes(y = coef)) +
  ggplot2::geom_ribbon(
    aes(
      ymin = coef - 2 * coef_se,
      ymax = coef + 2 * coef_se
    ),
    fill  = "grey70",
    alpha = 0.8
  ) +
  ggplot2::scale_x_datetime(
    date_labels = '%Y',
    date_breaks = '1 year'
  ) +
  ggplot2::geom_vline(
    aes(xintercept = as.numeric(dates)),
    data     = df_intervention_period,
    linetype = "dashed",
    colour   = "red"
  ) +
  ggplot2::geom_hline(
    aes(yintercept = 0),
    linetype = 'dashed',
    alpha    = 0.6
  ) +
  ggplot2::labs(
    y = NULL, 
    x = NULL
  ) +
  ggplot2::facet_wrap(
    ncol   = 1,
    facets = . ~ predictor
  )
```

## Distributed lag model

```{r}
dataset %>% 
  dplyr::group_by(district) %>% 
  dplyr::arrange(reporting_date) %>% 
  dplyr::mutate(
    aet_lag1   = lag(aet_std),
    prcp_lag1  = lag(prcp_std),
    q_lag1     = lag(q_std),
    soilm_lag1 = lag(soilm_std),
    tmax_lag1  = lag(tmax_std),
    tmin_lag1  = lag(tmin_std)
  ) -> dataset
```

```{r}
tictoc::tic("GAMM model fitting")
vivax_gam_nb_s_aet_l1 <- gamm4(
  formula = 
    vivax ~ 
    offset(log(pop2015)) + s(reporting_time, by = aet_lag1),
  random  = ~ (1 | province/district),
  family  = negbin(theta=getME(vivax_glm_nb_base, "glmer.nb.theta")),
  data    = dataset[! is.na(dataset$aet_lag1), ],
  REML    = TRUE
)
tictoc::toc()
```

```{r}
summary(vivax_gam_nb_s_aet_l1$mer)
```

