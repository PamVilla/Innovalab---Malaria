---
title: "Rolling"
output: 
  html_document:
    toc: true
    toc_float: true
    df_print: "paged"
    fig_width: 12
    fig_height: 9
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(corrr)
library(corrplot)
library(magrittr)
library(MASS)
library(slider)
library(ggpubr)
```

# Carga de datos

```{r echo=TRUE, message=FALSE, warning=FALSE}
dt_final<-read.csv("./_data/dt_final.csv")
head(dt_final)
```

# Configurando

```{r echo=TRUE, message=FALSE, warning=FALSE}
dt_final %<>% 
  mutate(
    year = lubridate::year(lubridate::parse_date_time(dt_final$year, "Y")),
    month = lubridate::month(lubridate::parse_date_time(dt_final$month, "m"))
  ) %>% 
  add_column(fecha = lubridate::make_date(year = dt_final$year, month = dt_final$month, day = 1L)) %>% 
  arrange(fecha)
```

# Matriz grafica de correlaciones

```{r echo=TRUE, message=FALSE, warning=FALSE}
dt_final %>% 
  dplyr::select(falciparum:tmin) %>% 
  cor() %>% 
  corrplot(method = "color", type = "lower", diag = F, addCoef.col = "darkgrey")
```

# Incidencia de Falciparum y Vivax en el tiempo
## Departamento (Loreto)
```{r echo=TRUE, message=FALSE, warning=FALSE}
dt_final %>% 
  group_by(fecha) %>% 
  summarise(
    sum_falciparum = sum(falciparum),
    sum_vivax = sum(vivax)
  ) %>% 
  ggplot(aes(x = fecha)) +
  geom_line(aes(y = sum_falciparum, colour = "sum_falciparum")) +
  geom_line(aes(y = sum_vivax, colour = "sum_vivax")) +
  labs(y= "Incidencia", x = "Meses")
```

## Provincias (de Loreto)

```{r echo=TRUE, message=FALSE, warning=FALSE}
dt_final %>% 
  group_by(NOMBPROV, fecha) %>% 
  summarise(
    sum_falciparum = sum(falciparum),
    sum_vivax = sum(vivax)
  ) %>% 
  ggplot(aes(x=fecha, group = NOMBPROV, colour = NOMBPROV)) +
  geom_line(aes(y=sum_falciparum, colour = "sum_falciparum")) +
  geom_line(aes(y=sum_vivax, colour = "sum_vivax")) +
  facet_wrap(.~NOMBPROV, scales = "free")
```

## Distritos (de Loreto)

```{r echo=TRUE, message=FALSE, warning=FALSE}
dt_final %>% 
  dplyr::select(NOMBDIST, fecha, falciparum, vivax) %>% 
  ggplot(aes(x=fecha, group = NOMBDIST)) +
  geom_line(aes(y = falciparum, colour = "falciparum")) +
  geom_line(aes(y = vivax, colour = "vivax")) +
  facet_wrap(.~NOMBDIST, scales = "free")
```

# Coeficientes de regresion en el tiempo
## Departamentos (Loreto)
### Ventanas de 12 meses

```{r echo=FALSE, message=FALSE, warning=FALSE}
monthly_model <- function(data) {
  mod_falci <- glm.nb(falciparum ~ aet + prcp + soilm + tmax, data = data)
  mod_vivax <- glm.nb(vivax ~ aet + prcp + soilm + tmax, data = data)
  
  tibble(
    from = min(data$fecha),
    to = max(data$fecha),
    coef_falci = summary(mod_falci)$coefficients[2:5,1],
    error_falci = summary(mod_falci)$coefficients[2:5,2],
    coef_vivax = summary(mod_vivax)$coefficients[2:5,1],
    error_vivax = summary(mod_vivax)$coefficients[2:5,2],
    promedios = c(mean(data$aet),mean(data$prcp),mean(data$soilm),mean(data$tmax))
  )
}

dt_final %>% 
  summarise(
    slide_period_dfr(
      across(everything()),
      fecha,
      "month",
      monthly_model,
      .every = 1,
      .before = 6,
      .after = 5,
      .complete = T
    )
  ) %>% 
  add_column(
    variable = rep(c("Aet","Prcp","Soilm","Tmax"), 205),
    fecha = rep(seq(as.Date("2000/7/1"), by = "month", length.out = 205), each = 4)
  ) %>% {
    ggarrange(
      ggplot(data = ., mapping = aes(x = fecha)) +
        geom_ribbon(mapping = aes(ymin = coef_falci - error_falci, 
                                  ymax = coef_falci + error_falci), 
                    alpha = 0.1, linetype = "dashed", fill = "red") +
        geom_ribbon(mapping = aes(ymin = coef_vivax - error_vivax, 
                                  ymax = coef_vivax + error_vivax), 
                    alpha = 0.1, linetype = "dashed", fill = "blue") +
        geom_line(mapping = aes(y = coef_falci, col = "Falciparum")) +
        geom_line(mapping = aes(y = coef_vivax, col = "Vivax")) +
        ylab("Coeficientes") +
        geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), 
                   linetype = "dashed") +
        geom_hline(yintercept = 0, 
                   linetype = "dashed") +
        facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1) +
        labs(colour = "Spp coef"),
      ggplot(data = ., aes(x = fecha)) +
        geom_line(mapping = aes(y = promedios), colour = "purple") + 
        ylab("Promedios") +
        geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), 
                   linetype = "dashed") +
        facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1),
      ncol = 2, 
      common.legend = T
    )
  }
```

### Ventanas de 18 meses

```{r echo=FALSE, message=FALSE, warning=FALSE}
dt_final %>% 
  summarise(
    slide_period_dfr(
      across(everything()),
      fecha,
      "month",
      monthly_model,
      .every = 1,
      .before = 9,
      .after = 8,
      .complete = T
    )
  ) %>% 
  add_column(
    variable = rep(c("Aet","Prcp","Soilm","Tmax"), 199),
    fecha = rep(seq(as.Date("2000/10/1"), by = "month", length.out = 199), each = 4)
  ) %>% {
    ggarrange(
      ggplot(data = ., mapping = aes(x = fecha)) +
        geom_ribbon(mapping = aes(ymin = coef_falci - error_falci, ymax = coef_falci + error_falci), 
                    alpha = 0.1, linetype = "dashed", fill = "red") +
        geom_ribbon(mapping = aes(ymin = coef_vivax - error_vivax, ymax = coef_vivax + error_vivax), 
                    alpha = 0.1, linetype = "dashed", fill = "blue") +
        geom_line(mapping = aes(y = coef_falci, col = "Falciparum")) +
        geom_line(mapping = aes(y = coef_vivax, col = "Vivax")) +
        ylab("Coeficientes") +
        geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), linetype = "dashed") +
        geom_hline(yintercept = 0, linetype = "dashed") +
        facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1) +
        labs(colour = "Spp coef"),
      ggplot(data = ., aes(x = fecha)) +
        geom_line(mapping = aes(y = promedios), colour = "purple") + 
        ylab("Promedios") +
        geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), linetype = "dashed") +
        facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1),
      ncol = 2, 
      common.legend = T
    )
  }

```

### Ventanas de 24 meses

```{r echo=FALSE, message=FALSE, warning=FALSE}
dt_final %>% 
  summarise(
    slide_period_dfr(
      across(everything()),
      fecha,
      "month",
      monthly_model,
      .every = 1,
      .before = 12,
      .after = 11,
      .complete = T
    )
  ) %>% 
  add_column(
    variable = rep(c("Aet","Prcp","Soilm","Tmax"), 193),
    fecha = rep(seq(as.Date("2001/1/1"), by = "month", length.out = 193), each = 4)
  ) %>% {
    ggarrange(
      ggplot(data = ., mapping = aes(x = fecha)) +
        geom_ribbon(mapping = aes(ymin = coef_falci - error_falci, ymax = coef_falci + error_falci), 
                    alpha = 0.1, linetype = "dashed", fill = "red") +
        geom_ribbon(mapping = aes(ymin = coef_vivax - error_vivax, ymax = coef_vivax + error_vivax), 
                    alpha = 0.1, linetype = "dashed", fill = "blue") +
        geom_line(mapping = aes(y = coef_falci, col = "Falciparum")) +
        geom_line(mapping = aes(y = coef_vivax, col = "Vivax")) +
        ylab("Coeficientes") +
        geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), linetype = "dashed") +
        geom_hline(yintercept = 0, linetype = "dashed") +
        facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1) +
        labs(colour = "Spp coef"),
      ggplot(data = ., aes(x = fecha)) +
        geom_line(mapping = aes(y = promedios), colour = "purple") + 
        ylab("Promedios") +
        geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), linetype = "dashed") +
        facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1),
      ncol = 2, 
      common.legend = T
    )
  }

```

## Provincias (de Loreto)
### Ventanas de 12 meses

```{r echo=FALSE, message=FALSE, warning=FALSE}
monthly_model <- function(data) {
  mod_falci <- glm.nb(falciparum ~ aet + prcp + soilm + tmax, data = data)
  mod_vivax <- glm.nb(vivax ~ aet + prcp + soilm + tmax, data = data)
  
  tibble(
    from = min(data$fecha),
    to = max(data$fecha),
    coef_falci = summary(mod_falci)$coefficients[2:5,1],
    error_falci = summary(mod_falci)$coefficients[2:5,2],
    coef_vivax = summary(mod_vivax)$coefficients[2:5,1],
    error_vivax = summary(mod_vivax)$coefficients[2:5,2],
    promedios = c(mean(data$aet),mean(data$prcp),mean(data$soilm),mean(data$tmax))
  )
}

d <- dt_final %>%
  group_by(NOMBPROV) %>% 
  filter(!NOMBPROV %in% c("PUTUMAYO","UCAYALI","ALTO AMAZONAS",
                          "DATEM DEL MARAï¿½ON","MARISCAL RAMON CASTILLA")) %>% 
  summarise(
    slide_period_dfr(
      across(everything()),
      fecha,
      "month",
      monthly_model,
      .every = 1,
      .before = 6,
      .after = 5,
      .complete = T
    )
  ) %>% 
  add_column(
    variable = rep(c("Aet","Prcp","Soilm","Tmax"), 615),
    fecha = rep(seq(as.Date("2000/7/1"), by = "month", length.out = 205), each = 4, times = 3)
  )
  
my_plot <- function(data){
  
  p1 <- ggplot(data = data, mapping = aes(x = fecha)) +
    geom_ribbon(mapping = aes(ymin = coef_falci - error_falci, ymax = coef_falci + error_falci), 
                alpha = 0.1, linetype = "dashed", fill = "red") +
    geom_ribbon(mapping = aes(ymin = coef_vivax - error_vivax, ymax = coef_vivax + error_vivax), 
                alpha = 0.1, linetype = "dashed", fill = "blue") +
    geom_line(mapping = aes(y = coef_falci, col = "Falciparum")) +
    geom_line(mapping = aes(y = coef_vivax, col = "Vivax")) +
    ylab("Coeficientes") +
    geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), linetype = "dashed") +
    geom_hline(yintercept = 0, linetype = "dashed") +
    facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1) +
    labs(colour = "Spp coef")
  
  p2 <- ggplot(data = data, aes(x = fecha)) +
    geom_line(mapping = aes(y = promedios), colour = "purple") + 
    ylab("Promedios") +
    geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), linetype = "dashed") +
    facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1)
  
  ggarrange(p1, p2, ncol = 2, common.legend = T)
  
}


plots <- d %>% 
  group_by(NOMBPROV) %>% 
  nest() %>% 
  mutate(p = lapply(data, my_plot))


```

#### LORETO

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$p[[1]]
```

#### MAYNAS

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$p[[2]]
```

#### REQUENA

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$p[[3]]
```

### Ventanas de 18 meses

```{r echo=FALSE, message=FALSE, warning=FALSE}
monthly_model <- function(data) {
  mod_falci <- glm.nb(falciparum ~ aet + prcp + soilm + tmax, data = data)
  mod_vivax <- glm.nb(vivax ~ aet + prcp + soilm + tmax, data = data)
  
  tibble(
    from = min(data$fecha),
    to = max(data$fecha),
    coef_falci = summary(mod_falci)$coefficients[2:5,1],
    error_falci = summary(mod_falci)$coefficients[2:5,2],
    coef_vivax = summary(mod_vivax)$coefficients[2:5,1],
    error_vivax = summary(mod_vivax)$coefficients[2:5,2],
    promedios = c(mean(data$aet),mean(data$prcp),mean(data$soilm),mean(data$tmax))
  )
}

d <- dt_final %>%
  group_by(NOMBPROV) %>% 
  filter(!NOMBPROV %in% c("PUTUMAYO","UCAYALI","ALTO AMAZONAS",
                          "DATEM DEL MARAï¿½ON","MARISCAL RAMON CASTILLA")) %>% 
  summarise(
    slide_period_dfr(
      across(everything()),
      fecha,
      "month",
      monthly_model,
      .every = 1,
      .before = 9,
      .after = 8,
      .complete = T
    )
  ) %>% 
  add_column(
    variable = rep(c("Aet","Prcp","Soilm","Tmax"), 597),
    fecha = rep(seq(as.Date("2000/10/1"), by = "month", length.out = 199), each = 4, times = 3)
  )
  
my_plot <- function(data){
  
  p1 <- ggplot(data = data, mapping = aes(x = fecha)) +
    geom_ribbon(mapping = aes(ymin = coef_falci - error_falci, ymax = coef_falci + error_falci), 
                alpha = 0.1, linetype = "dashed", fill = "red") +
    geom_ribbon(mapping = aes(ymin = coef_vivax - error_vivax, ymax = coef_vivax + error_vivax), 
                alpha = 0.1, linetype = "dashed", fill = "blue") +
    geom_line(mapping = aes(y = coef_falci, col = "Falciparum")) +
    geom_line(mapping = aes(y = coef_vivax, col = "Vivax")) +
    ylab("Coeficientes") +
    geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), linetype = "dashed") +
    geom_hline(yintercept = 0, linetype = "dashed") +
    facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1) +
    labs(colour = "Spp coef")
  
  p2 <- ggplot(data = data, aes(x = fecha)) +
    geom_line(mapping = aes(y = promedios), colour = "purple") + 
    ylab("Promedios") +
    geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), linetype = "dashed") +
    facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1)
  
  ggarrange(p1, p2, ncol = 2, common.legend = T)
  
}


plots <- d %>% 
  group_by(NOMBPROV) %>% 
  nest() %>% 
  mutate(p = lapply(data, my_plot))


```

#### LORETO

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$p[[1]]
```

#### MAYNAS

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$p[[2]]
```

#### REQUENA

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$p[[3]]
```

### Ventanas de 24 meses

```{r echo=FALSE, message=FALSE, warning=FALSE}
monthly_model <- function(data) {
  mod_falci <- glm.nb(falciparum ~ aet + prcp + soilm + tmax, data = data)
  mod_vivax <- glm.nb(vivax ~ aet + prcp + soilm + tmax, data = data)
  
  tibble(
    from = min(data$fecha),
    to = max(data$fecha),
    coef_falci = summary(mod_falci)$coefficients[2:5,1],
    error_falci = summary(mod_falci)$coefficients[2:5,2],
    coef_vivax = summary(mod_vivax)$coefficients[2:5,1],
    error_vivax = summary(mod_vivax)$coefficients[2:5,2],
    promedios = c(mean(data$aet),mean(data$prcp),mean(data$soilm),mean(data$tmax))
  )
}

d <- dt_final %>%
  group_by(NOMBPROV) %>% 
  filter(!NOMBPROV %in% c("PUTUMAYO","UCAYALI","ALTO AMAZONAS",
                          "DATEM DEL MARAï¿½ON","MARISCAL RAMON CASTILLA")) %>% 
  summarise(
    slide_period_dfr(
      across(everything()),
      fecha,
      "month",
      monthly_model,
      .every = 1,
      .before = 12,
      .after = 11,
      .complete = T
    )
  ) %>% 
  add_column(
    variable = rep(c("Aet","Prcp","Soilm","Tmax"), 579),
    fecha = rep(seq(as.Date("2001/1/1"), by = "month", length.out = 193), each = 4, times = 3)
  )
  
my_plot <- function(data){
  
  p1 <- ggplot(data = data, mapping = aes(x = fecha)) +
    geom_ribbon(mapping = aes(ymin = coef_falci - error_falci, ymax = coef_falci + error_falci), 
                alpha = 0.1, linetype = "dashed", fill = "red") +
    geom_ribbon(mapping = aes(ymin = coef_vivax - error_vivax, ymax = coef_vivax + error_vivax), 
                alpha = 0.1, linetype = "dashed", fill = "blue") +
    geom_line(mapping = aes(y = coef_falci, col = "Falciparum")) +
    geom_line(mapping = aes(y = coef_vivax, col = "Vivax")) +
    ylab("Coeficientes") +
    geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), linetype = "dashed") +
    geom_hline(yintercept = 0, linetype = "dashed") +
    facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1) +
    labs(colour = "Spp coef")
  
  p2 <- ggplot(data = data, aes(x = fecha)) +
    geom_line(mapping = aes(y = promedios), colour = "purple") + 
    ylab("Promedios") +
    geom_vline(xintercept = c(as.Date("2006/1/1"),as.Date("2010/12/1")), linetype = "dashed") +
    facet_wrap(.~variable, scales = "free", nrow = 4, ncol = 1)
  
  ggarrange(p1, p2, ncol = 2, common.legend = T)
  
}


plots <- d %>% 
  group_by(NOMBPROV) %>% 
  nest() %>% 
  mutate(p = lapply(data, my_plot))


```

#### LORETO

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$p[[1]]
```

#### MAYNAS

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$p[[2]]
```

#### REQUENA

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$p[[3]]
```
