---
title: "Rolling"
output:
  github_document:
    df_print: "kable"
    fig_width: 12
    fig_height: 9
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(corrr)
library(magrittr)
library(MASS)
library(slider)
```

### Carga de datos

```{r echo=TRUE, message=FALSE, warning=FALSE}
dt_final<-read.csv("./_data/dt_final.csv")
head(dt_final)
```

### Configurando

```{r echo=TRUE, message=FALSE, warning=FALSE}
dt_final %<>% 
  mutate(
    year = lubridate::year(lubridate::parse_date_time(dt_final$year, "Y")),
    month = lubridate::month(lubridate::parse_date_time(dt_final$month, "m"))
  ) %>% 
  add_column(fecha = lubridate::make_date(year = dt_final$year, month = dt_final$month, day = 1L)) %>% 
  arrange(fecha)
```

### Matriz grafica de correlaciones

```{r echo=TRUE, message=FALSE, warning=FALSE}
dt_final %>% 
  dplyr::select(falciparum:tmax) %>% 
  correlate() %>% 
  rplot(shape = 15, colors = c("red", "green"))
```

### Incidencia de falciparum en el tiempo por distrito

```{r echo=TRUE, message=FALSE, warning=FALSE}
dt_final %>% 
  dplyr::select(NOMBDIST, year, month, falciparum) %>% 
  mutate(fecha = lubridate::make_date(year = year, month = month, day = 1L)) %>%
  ggplot(aes(x=fecha, y=falciparum, group = NOMBDIST, colour = NOMBDIST)) +
    theme(legend.position = "none") +
    geom_line()+facet_wrap(.~NOMBDIST)
```

### Incidencia de vivax en el tiempo por distrito

```{r echo=TRUE, message=FALSE, warning=FALSE}
dt_final %>% 
  dplyr::select(NOMBDIST, year, month, vivax) %>% 
  mutate(fecha = lubridate::make_date(year = year, month = month, day = 1L)) %>%
  ggplot(aes(x=fecha, y=vivax, group = NOMBDIST, colour = NOMBDIST)) +
  theme(legend.position = "none") +
  geom_line()+facet_wrap(.~NOMBDIST)
```

### Coeficientes de regresion en el tiempo
#### Falciparum - Ventanas de 12 meses

```{r echo=TRUE, message=FALSE, warning=FALSE}
df_betas <- slide_period_dfr(
  .x = dt_final,
  .i = dt_final$fecha,
  .period = "month",
  ~data.frame(
    Aet = coef(glm.nb(formula = falciparum ~ aet + prcp + soilm + tmax, data = .x))[[2]],
    Prcp = coef(glm.nb(formula = falciparum ~ aet + prcp + soilm + tmax, data = .x))[[3]],
    Solim = coef(glm.nb(formula = falciparum ~ aet + prcp + soilm + tmax, data = .x))[[4]],
    Tmax = coef(glm.nb(formula = falciparum ~ aet + prcp + soilm + tmax, data = .x))[[5]]
  ),
  .every = 12,
  .complete = T
)

for (i in colnames(df_betas)) {
  print(ggplot(data = df_betas, aes(x = seq(2000,2017), y=.data[[i]])) +
          labs(y= "Coeficiente", x = "Año") +
          labs(title=i) +
          geom_line())
}
```

### Coeficientes de regresion en el tiempo
#### Vivax - Ventanas de 12 meses

```{r echo=TRUE, message=FALSE, warning=FALSE}
df_betas <- slide_period_dfr(
  .x = dt_final,
  .i = dt_final$fecha,
  .period = "month",
  ~data.frame(
    Aet = coef(glm.nb(formula = vivax ~ aet + prcp + soilm + tmax, data = .x))[[2]],
    Prcp = coef(glm.nb(formula = vivax ~ aet + prcp + soilm + tmax, data = .x))[[3]],
    Solim = coef(glm.nb(formula = vivax ~ aet + prcp + soilm + tmax, data = .x))[[4]],
    Tmax = coef(glm.nb(formula = vivax ~ aet + prcp + soilm + tmax, data = .x))[[5]]
  ),
  .every = 12,
  .complete = T
)

for (i in colnames(df_betas)) {
  print(ggplot(data = df_betas, aes(x = seq(2000,2017), y=.data[[i]])) +
          labs(y= "Coeficiente", x = "Año") +
          labs(title=i) +
          geom_line())
}
```

### Coeficientes de regresion en el tiempo
#### Falciparum - Ventanas de 12 meses cada mes

```{r echo=TRUE, message=FALSE, warning=FALSE}
df_betas <- slide_period_dfr(
  .x = dt_final,
  .i = dt_final$fecha,
  .period = "month",
  ~data.frame(
    Aet = coef(glm.nb(formula = falciparum ~ aet + prcp + soilm + tmax, data = .x))[[2]],
    Prcp = coef(glm.nb(formula = falciparum ~ aet + prcp + soilm + tmax, data = .x))[[3]],
    Solim = coef(glm.nb(formula = falciparum ~ aet + prcp + soilm + tmax, data = .x))[[4]],
    Tmax = coef(glm.nb(formula = falciparum ~ aet + prcp + soilm + tmax, data = .x))[[5]]
  ),
  .every = 1,
  .after = 11,
  .complete = T
)

for (i in colnames(df_betas)) {
  print(ggplot(data = df_betas, aes(x = seq(1,205), y=.data[[i]])) +
          labs(y= "Coeficiente", x = "Mes") +
          labs(title=i) +
          geom_line())
}
```

### Coeficientes de regresion en el tiempo
#### Vivax - Ventanas de 12 meses cada mes

```{r echo=TRUE, message=FALSE, warning=FALSE}
df_betas <- slide_period_dfr(
  .x = dt_final,
  .i = dt_final$fecha,
  .period = "month",
  ~data.frame(
    Aet = coef(glm.nb(formula = vivax ~ aet + prcp + soilm + tmax, data = .x))[[2]],
    Prcp = coef(glm.nb(formula = vivax ~ aet + prcp + soilm + tmax, data = .x))[[3]],
    Solim = coef(glm.nb(formula = vivax ~ aet + prcp + soilm + tmax, data = .x))[[4]],
    Tmax = coef(glm.nb(formula = vivax ~ aet + prcp + soilm + tmax, data = .x))[[5]]
  ),
  .every = 1,
  .after = 11,
  .complete = T
)

for (i in colnames(df_betas)) {
  print(ggplot(data = df_betas, aes(x = seq(1,205), y=.data[[i]])) +
          labs(y= "Coeficiente", x = "Mes") +
          labs(title=i) +
          geom_line())
}
```

